!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("cross-fetch"),require("eciesjs"),require("eventemitter2"),require("socket.io-client")):"function"==typeof define&&define.amd?define(["exports","cross-fetch","eciesjs","eventemitter2","socket.io-client"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).browser={},e.crossFetch,e.eciesjs,e.eventemitter2,e.socket_ioClient)}(this,(function(e,t,n,o,i){"use strict";function r(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;var s="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function a(){throw new Error("setTimeout has not been defined")}function c(){throw new Error("clearTimeout has not been defined")}var l=a,u=c;function d(e){if(l===setTimeout)return setTimeout(e,0);if((l===a||!l)&&setTimeout)return l=setTimeout,setTimeout(e,0);try{return l(e,0)}catch(t){try{return l.call(null,e,0)}catch(t){return l.call(this,e,0)}}}"function"==typeof s.setTimeout&&(l=setTimeout),"function"==typeof s.clearTimeout&&(u=clearTimeout);var h,g=[],y=!1,m=-1;function v(){y&&h&&(y=!1,h.length?g=h.concat(g):m=-1,g.length&&f())}function f(){if(!y){var e=d(v);y=!0;for(var t=g.length;t;){for(h=g,g=[];++m<t;)h&&h[m].run();m=-1,t=g.length}h=null,y=!1,function(e){if(u===clearTimeout)return clearTimeout(e);if((u===c||!u)&&clearTimeout)return u=clearTimeout,clearTimeout(e);try{return u(e)}catch(t){try{return u.call(null,e)}catch(t){return u.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}p.prototype.run=function(){this.fun.apply(null,this.array)};function E(){}var C=E,S=E,T=E,k=E,x=E,K=E,I=E;var _=s.performance||{},w=_.now||_.mozNow||_.msNow||_.oNow||_.webkitNow||function(){return(new Date).getTime()};var A=new Date;var R={nextTick:function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];g.push(new p(e,t)),1!==g.length||y||d(f)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:C,addListener:S,once:T,off:k,removeListener:x,removeAllListeners:K,emit:I,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*w.call(_),n=Math.floor(t),o=Math.floor(t%1*1e9);return e&&(n-=e[0],(o-=e[1])<0&&(n--,o+=1e9)),[n,o]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-A)/1e3}};function b(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var N,O,P={exports:{}};function M(){if(O)return N;O=1;var e=1e3,t=60*e,n=60*t,o=24*n,i=7*o,r=365.25*o;function s(e,t,n,o){var i=t>=1.5*n;return Math.round(e/n)+" "+o+(i?"s":"")}return N=function(a,c){c=c||{};var l=typeof a;if("string"===l&&a.length>0)return function(s){if((s=String(s)).length>100)return;var a=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(s);if(!a)return;var c=parseFloat(a[1]);switch((a[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return c*r;case"weeks":case"week":case"w":return c*i;case"days":case"day":case"d":return c*o;case"hours":case"hour":case"hrs":case"hr":case"h":return c*n;case"minutes":case"minute":case"mins":case"min":case"m":return c*t;case"seconds":case"second":case"secs":case"sec":case"s":return c*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c;default:return}}(a);if("number"===l&&isFinite(a))return c.long?function(i){var r=Math.abs(i);if(r>=o)return s(i,r,o,"day");if(r>=n)return s(i,r,n,"hour");if(r>=t)return s(i,r,t,"minute");if(r>=e)return s(i,r,e,"second");return i+" ms"}(a):function(i){var r=Math.abs(i);if(r>=o)return Math.round(i/o)+"d";if(r>=n)return Math.round(i/n)+"h";if(r>=t)return Math.round(i/t)+"m";if(r>=e)return Math.round(i/e)+"s";return i+"ms"}(a);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(a))}}var D=function(e){function t(e){let o,i,r,s=null;function a(...e){if(!a.enabled)return;const n=a,i=Number(new Date),r=i-(o||i);n.diff=r,n.prev=o,n.curr=i,o=i,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let s=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((o,i)=>{if("%%"===o)return"%";s++;const r=t.formatters[i];if("function"==typeof r){const t=e[s];o=r.call(n,t),e.splice(s,1),s--}return o})),t.formatArgs.call(n,e);(n.log||t.log).apply(n,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=n,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==s?s:(i!==t.namespaces&&(i=t.namespaces,r=t.enabled(e)),r),set:e=>{s=e}}),"function"==typeof t.init&&t.init(a),a}function n(e,n){const o=t(this.namespace+(void 0===n?":":n)+e);return o.log=this.log,o}function o(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names.map(o),...t.skips.map(o).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let n;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const o=("string"==typeof e?e:"").split(/[\s,]+/),i=o.length;for(n=0;n<i;n++)o[n]&&("-"===(e=o[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.slice(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let n,o;for(n=0,o=t.skips.length;n<o;n++)if(t.skips[n].test(e))return!1;for(n=0,o=t.names.length;n<o;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=M(),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((n=>{t[n]=e[n]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return t.colors[Math.abs(n)%t.colors.length]},t.enable(t.load()),t};!function(e,t){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;t.splice(1,0,n,"color: inherit");let o=0,i=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(o++,"%c"===e&&(i=o))})),t.splice(i,0,n)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&void 0!==R&&"env"in R&&(e=R.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=D(t);const{formatters:n}=e.exports;n.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}(P,P.exports);var L=b(P.exports);const $=L("KeyExchange:Layer"),H=L("SocketService:Layer"),U=L("Ecies:Layer"),Y=L("RemoteCommunication:Layer");$.color="##95c44e",H.color="#f638d7",U.color="#465b9c",Y.color="#47a2be";const F={KeyExchange:$,SocketService:H,Ecies:U,RemoteCommunication:Y};let j,z=[],B=[];function V(e){return r(this,void 0,void 0,(function*(){if(!j||!e)return;!function(){const e=B;B=z,z=e}();const n=j.endsWith("/")?`${j}evt`:`${j}/evt`,o=Object.assign({},e);if(delete o.params,e.params)for(const[t,n]of Object.entries(e.params))o[t]=n;const i=JSON.stringify(o);F.RemoteCommunication(`[sendBufferedEvents] Sending ${z.length} analytics events to ${n}`);try{const e=yield t(n,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:i}),o=yield e.text();F.RemoteCommunication(`[sendBufferedEvents] Response: ${o}`),z.length=0}catch(e){console.warn("Error sending analytics",e)}}))}const G=(e,t)=>r(void 0,void 0,void 0,(function*(){var n;j=t,n=e,B.push(n),V(e).catch((()=>{}))}));var W=[],J=[],Z="undefined"!=typeof Uint8Array?Uint8Array:Array,q=!1;function X(){q=!0;for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=0;t<64;++t)W[t]=e[t],J[e.charCodeAt(t)]=t;J["-".charCodeAt(0)]=62,J["_".charCodeAt(0)]=63}function Q(e,t,n){for(var o,i,r=[],s=t;s<n;s+=3)o=(e[s]<<16)+(e[s+1]<<8)+e[s+2],r.push(W[(i=o)>>18&63]+W[i>>12&63]+W[i>>6&63]+W[63&i]);return r.join("")}function ee(e){var t;q||X();for(var n=e.length,o=n%3,i="",r=[],s=16383,a=0,c=n-o;a<c;a+=s)r.push(Q(e,a,a+s>c?c:a+s));return 1===o?(t=e[n-1],i+=W[t>>2],i+=W[t<<4&63],i+="=="):2===o&&(t=(e[n-2]<<8)+e[n-1],i+=W[t>>10],i+=W[t>>4&63],i+=W[t<<2&63],i+="="),r.push(i),r.join("")}function te(e,t,n,o,i){var r,s,a=8*i-o-1,c=(1<<a)-1,l=c>>1,u=-7,d=n?i-1:0,h=n?-1:1,g=e[t+d];for(d+=h,r=g&(1<<-u)-1,g>>=-u,u+=a;u>0;r=256*r+e[t+d],d+=h,u-=8);for(s=r&(1<<-u)-1,r>>=-u,u+=o;u>0;s=256*s+e[t+d],d+=h,u-=8);if(0===r)r=1-l;else{if(r===c)return s?NaN:1/0*(g?-1:1);s+=Math.pow(2,o),r-=l}return(g?-1:1)*s*Math.pow(2,r-o)}function ne(e,t,n,o,i,r){var s,a,c,l=8*r-i-1,u=(1<<l)-1,d=u>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,g=o?0:r-1,y=o?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=u):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+d>=1?h/c:h*Math.pow(2,1-d))*c>=2&&(s++,c/=2),s+d>=u?(a=0,s=u):s+d>=1?(a=(t*c-1)*Math.pow(2,i),s+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,i),s=0));i>=8;e[n+g]=255&a,g+=y,a/=256,i-=8);for(s=s<<i|a,l+=i;l>0;e[n+g]=255&s,g+=y,s/=256,l-=8);e[n+g-y]|=128*m}var oe={}.toString,ie=Array.isArray||function(e){return"[object Array]"==oe.call(e)};function re(){return ae.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function se(e,t){if(re()<t)throw new RangeError("Invalid typed array length");return ae.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=ae.prototype:(null===e&&(e=new ae(t)),e.length=t),e}function ae(e,t,n){if(!(ae.TYPED_ARRAY_SUPPORT||this instanceof ae))return new ae(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return ue(this,e)}return ce(this,e,t,n)}function ce(e,t,n,o){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,o){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(o||0))throw new RangeError("'length' is out of bounds");t=void 0===n&&void 0===o?new Uint8Array(t):void 0===o?new Uint8Array(t,n):new Uint8Array(t,n,o);ae.TYPED_ARRAY_SUPPORT?(e=t).__proto__=ae.prototype:e=de(e,t);return e}(e,t,n,o):"string"==typeof t?function(e,t,n){"string"==typeof n&&""!==n||(n="utf8");if(!ae.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var o=0|ye(t,n);e=se(e,o);var i=e.write(t,n);i!==o&&(e=e.slice(0,i));return e}(e,t,n):function(e,t){if(ge(t)){var n=0|he(t.length);return 0===(e=se(e,n)).length||t.copy(e,0,0,n),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(o=t.length)!=o?se(e,0):de(e,t);if("Buffer"===t.type&&ie(t.data))return de(e,t.data)}var o;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function le(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function ue(e,t){if(le(t),e=se(e,t<0?0:0|he(t)),!ae.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function de(e,t){var n=t.length<0?0:0|he(t.length);e=se(e,n);for(var o=0;o<n;o+=1)e[o]=255&t[o];return e}function he(e){if(e>=re())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+re().toString(16)+" bytes");return 0|e}function ge(e){return!(null==e||!e._isBuffer)}function ye(e,t){if(ge(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var o=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return Ye(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return Fe(e).length;default:if(o)return Ye(e).length;t=(""+t).toLowerCase(),o=!0}}function me(e,t,n){var o=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return Re(this,t,n);case"utf8":case"utf-8":return Ie(this,t,n);case"ascii":return we(this,t,n);case"latin1":case"binary":return Ae(this,t,n);case"base64":return Ke(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return be(this,t,n);default:if(o)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),o=!0}}function ve(e,t,n){var o=e[t];e[t]=e[n],e[n]=o}function fe(e,t,n,o,i){if(0===e.length)return-1;if("string"==typeof n?(o=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=i?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof t&&(t=ae.from(t,o)),ge(t))return 0===t.length?-1:pe(e,t,n,o,i);if("number"==typeof t)return t&=255,ae.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):pe(e,[t],n,o,i);throw new TypeError("val must be string, number or Buffer")}function pe(e,t,n,o,i){var r,s=1,a=e.length,c=t.length;if(void 0!==o&&("ucs2"===(o=String(o).toLowerCase())||"ucs-2"===o||"utf16le"===o||"utf-16le"===o)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,n/=2}function l(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var u=-1;for(r=n;r<a;r++)if(l(e,r)===l(t,-1===u?0:r-u)){if(-1===u&&(u=r),r-u+1===c)return u*s}else-1!==u&&(r-=r-u),u=-1}else for(n+c>a&&(n=a-c),r=n;r>=0;r--){for(var d=!0,h=0;h<c;h++)if(l(e,r+h)!==l(t,h)){d=!1;break}if(d)return r}return-1}function Ee(e,t,n,o){n=Number(n)||0;var i=e.length-n;o?(o=Number(o))>i&&(o=i):o=i;var r=t.length;if(r%2!=0)throw new TypeError("Invalid hex string");o>r/2&&(o=r/2);for(var s=0;s<o;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[n+s]=a}return s}function Ce(e,t,n,o){return je(Ye(t,e.length-n),e,n,o)}function Se(e,t,n,o){return je(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,o)}function Te(e,t,n,o){return Se(e,t,n,o)}function ke(e,t,n,o){return je(Fe(t),e,n,o)}function xe(e,t,n,o){return je(function(e,t){for(var n,o,i,r=[],s=0;s<e.length&&!((t-=2)<0);++s)o=(n=e.charCodeAt(s))>>8,i=n%256,r.push(i),r.push(o);return r}(t,e.length-n),e,n,o)}function Ke(e,t,n){return 0===t&&n===e.length?ee(e):ee(e.slice(t,n))}function Ie(e,t,n){n=Math.min(e.length,n);for(var o=[],i=t;i<n;){var r,s,a,c,l=e[i],u=null,d=l>239?4:l>223?3:l>191?2:1;if(i+d<=n)switch(d){case 1:l<128&&(u=l);break;case 2:128==(192&(r=e[i+1]))&&(c=(31&l)<<6|63&r)>127&&(u=c);break;case 3:r=e[i+1],s=e[i+2],128==(192&r)&&128==(192&s)&&(c=(15&l)<<12|(63&r)<<6|63&s)>2047&&(c<55296||c>57343)&&(u=c);break;case 4:r=e[i+1],s=e[i+2],a=e[i+3],128==(192&r)&&128==(192&s)&&128==(192&a)&&(c=(15&l)<<18|(63&r)<<12|(63&s)<<6|63&a)>65535&&c<1114112&&(u=c)}null===u?(u=65533,d=1):u>65535&&(u-=65536,o.push(u>>>10&1023|55296),u=56320|1023&u),o.push(u),i+=d}return function(e){var t=e.length;if(t<=_e)return String.fromCharCode.apply(String,e);var n="",o=0;for(;o<t;)n+=String.fromCharCode.apply(String,e.slice(o,o+=_e));return n}(o)}ae.TYPED_ARRAY_SUPPORT=void 0===s.TYPED_ARRAY_SUPPORT||s.TYPED_ARRAY_SUPPORT,re(),ae.poolSize=8192,ae._augment=function(e){return e.__proto__=ae.prototype,e},ae.from=function(e,t,n){return ce(null,e,t,n)},ae.TYPED_ARRAY_SUPPORT&&(ae.prototype.__proto__=Uint8Array.prototype,ae.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&ae[Symbol.species]),ae.alloc=function(e,t,n){return function(e,t,n,o){return le(t),t<=0?se(e,t):void 0!==n?"string"==typeof o?se(e,t).fill(n,o):se(e,t).fill(n):se(e,t)}(null,e,t,n)},ae.allocUnsafe=function(e){return ue(null,e)},ae.allocUnsafeSlow=function(e){return ue(null,e)},ae.isBuffer=function(e){return null!=e&&(!!e._isBuffer||ze(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&ze(e.slice(0,0))}(e))},ae.compare=function(e,t){if(!ge(e)||!ge(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,o=t.length,i=0,r=Math.min(n,o);i<r;++i)if(e[i]!==t[i]){n=e[i],o=t[i];break}return n<o?-1:o<n?1:0},ae.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},ae.concat=function(e,t){if(!ie(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return ae.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var o=ae.allocUnsafe(t),i=0;for(n=0;n<e.length;++n){var r=e[n];if(!ge(r))throw new TypeError('"list" argument must be an Array of Buffers');r.copy(o,i),i+=r.length}return o},ae.byteLength=ye,ae.prototype._isBuffer=!0,ae.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)ve(this,t,t+1);return this},ae.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)ve(this,t,t+3),ve(this,t+1,t+2);return this},ae.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)ve(this,t,t+7),ve(this,t+1,t+6),ve(this,t+2,t+5),ve(this,t+3,t+4);return this},ae.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?Ie(this,0,e):me.apply(this,arguments)},ae.prototype.equals=function(e){if(!ge(e))throw new TypeError("Argument must be a Buffer");return this===e||0===ae.compare(this,e)},ae.prototype.inspect=function(){var e="";return this.length>0&&(e=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(e+=" ... ")),"<Buffer "+e+">"},ae.prototype.compare=function(e,t,n,o,i){if(!ge(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===o&&(o=0),void 0===i&&(i=this.length),t<0||n>e.length||o<0||i>this.length)throw new RangeError("out of range index");if(o>=i&&t>=n)return 0;if(o>=i)return-1;if(t>=n)return 1;if(this===e)return 0;for(var r=(i>>>=0)-(o>>>=0),s=(n>>>=0)-(t>>>=0),a=Math.min(r,s),c=this.slice(o,i),l=e.slice(t,n),u=0;u<a;++u)if(c[u]!==l[u]){r=c[u],s=l[u];break}return r<s?-1:s<r?1:0},ae.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},ae.prototype.indexOf=function(e,t,n){return fe(this,e,t,n,!0)},ae.prototype.lastIndexOf=function(e,t,n){return fe(this,e,t,n,!1)},ae.prototype.write=function(e,t,n,o){if(void 0===t)o="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)o=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===o&&(o="utf8")):(o=n,n=void 0)}var i=this.length-t;if((void 0===n||n>i)&&(n=i),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");o||(o="utf8");for(var r=!1;;)switch(o){case"hex":return Ee(this,e,t,n);case"utf8":case"utf-8":return Ce(this,e,t,n);case"ascii":return Se(this,e,t,n);case"latin1":case"binary":return Te(this,e,t,n);case"base64":return ke(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return xe(this,e,t,n);default:if(r)throw new TypeError("Unknown encoding: "+o);o=(""+o).toLowerCase(),r=!0}},ae.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var _e=4096;function we(e,t,n){var o="";n=Math.min(e.length,n);for(var i=t;i<n;++i)o+=String.fromCharCode(127&e[i]);return o}function Ae(e,t,n){var o="";n=Math.min(e.length,n);for(var i=t;i<n;++i)o+=String.fromCharCode(e[i]);return o}function Re(e,t,n){var o=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>o)&&(n=o);for(var i="",r=t;r<n;++r)i+=Ue(e[r]);return i}function be(e,t,n){for(var o=e.slice(t,n),i="",r=0;r<o.length;r+=2)i+=String.fromCharCode(o[r]+256*o[r+1]);return i}function Ne(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function Oe(e,t,n,o,i,r){if(!ge(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<r)throw new RangeError('"value" argument is out of bounds');if(n+o>e.length)throw new RangeError("Index out of range")}function Pe(e,t,n,o){t<0&&(t=65535+t+1);for(var i=0,r=Math.min(e.length-n,2);i<r;++i)e[n+i]=(t&255<<8*(o?i:1-i))>>>8*(o?i:1-i)}function Me(e,t,n,o){t<0&&(t=4294967295+t+1);for(var i=0,r=Math.min(e.length-n,4);i<r;++i)e[n+i]=t>>>8*(o?i:3-i)&255}function De(e,t,n,o,i,r){if(n+o>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function Le(e,t,n,o,i){return i||De(e,0,n,4),ne(e,t,n,o,23,4),n+4}function $e(e,t,n,o,i){return i||De(e,0,n,8),ne(e,t,n,o,52,8),n+8}ae.prototype.slice=function(e,t){var n,o=this.length;if((e=~~e)<0?(e+=o)<0&&(e=0):e>o&&(e=o),(t=void 0===t?o:~~t)<0?(t+=o)<0&&(t=0):t>o&&(t=o),t<e&&(t=e),ae.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=ae.prototype;else{var i=t-e;n=new ae(i,void 0);for(var r=0;r<i;++r)n[r]=this[r+e]}return n},ae.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||Ne(e,t,this.length);for(var o=this[e],i=1,r=0;++r<t&&(i*=256);)o+=this[e+r]*i;return o},ae.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||Ne(e,t,this.length);for(var o=this[e+--t],i=1;t>0&&(i*=256);)o+=this[e+--t]*i;return o},ae.prototype.readUInt8=function(e,t){return t||Ne(e,1,this.length),this[e]},ae.prototype.readUInt16LE=function(e,t){return t||Ne(e,2,this.length),this[e]|this[e+1]<<8},ae.prototype.readUInt16BE=function(e,t){return t||Ne(e,2,this.length),this[e]<<8|this[e+1]},ae.prototype.readUInt32LE=function(e,t){return t||Ne(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},ae.prototype.readUInt32BE=function(e,t){return t||Ne(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},ae.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||Ne(e,t,this.length);for(var o=this[e],i=1,r=0;++r<t&&(i*=256);)o+=this[e+r]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*t)),o},ae.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||Ne(e,t,this.length);for(var o=t,i=1,r=this[e+--o];o>0&&(i*=256);)r+=this[e+--o]*i;return r>=(i*=128)&&(r-=Math.pow(2,8*t)),r},ae.prototype.readInt8=function(e,t){return t||Ne(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},ae.prototype.readInt16LE=function(e,t){t||Ne(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},ae.prototype.readInt16BE=function(e,t){t||Ne(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},ae.prototype.readInt32LE=function(e,t){return t||Ne(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},ae.prototype.readInt32BE=function(e,t){return t||Ne(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},ae.prototype.readFloatLE=function(e,t){return t||Ne(e,4,this.length),te(this,e,!0,23,4)},ae.prototype.readFloatBE=function(e,t){return t||Ne(e,4,this.length),te(this,e,!1,23,4)},ae.prototype.readDoubleLE=function(e,t){return t||Ne(e,8,this.length),te(this,e,!0,52,8)},ae.prototype.readDoubleBE=function(e,t){return t||Ne(e,8,this.length),te(this,e,!1,52,8)},ae.prototype.writeUIntLE=function(e,t,n,o){(e=+e,t|=0,n|=0,o)||Oe(this,e,t,n,Math.pow(2,8*n)-1,0);var i=1,r=0;for(this[t]=255&e;++r<n&&(i*=256);)this[t+r]=e/i&255;return t+n},ae.prototype.writeUIntBE=function(e,t,n,o){(e=+e,t|=0,n|=0,o)||Oe(this,e,t,n,Math.pow(2,8*n)-1,0);var i=n-1,r=1;for(this[t+i]=255&e;--i>=0&&(r*=256);)this[t+i]=e/r&255;return t+n},ae.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,1,255,0),ae.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},ae.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,2,65535,0),ae.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Pe(this,e,t,!0),t+2},ae.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,2,65535,0),ae.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Pe(this,e,t,!1),t+2},ae.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,4,4294967295,0),ae.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):Me(this,e,t,!0),t+4},ae.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,4,4294967295,0),ae.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):Me(this,e,t,!1),t+4},ae.prototype.writeIntLE=function(e,t,n,o){if(e=+e,t|=0,!o){var i=Math.pow(2,8*n-1);Oe(this,e,t,n,i-1,-i)}var r=0,s=1,a=0;for(this[t]=255&e;++r<n&&(s*=256);)e<0&&0===a&&0!==this[t+r-1]&&(a=1),this[t+r]=(e/s>>0)-a&255;return t+n},ae.prototype.writeIntBE=function(e,t,n,o){if(e=+e,t|=0,!o){var i=Math.pow(2,8*n-1);Oe(this,e,t,n,i-1,-i)}var r=n-1,s=1,a=0;for(this[t+r]=255&e;--r>=0&&(s*=256);)e<0&&0===a&&0!==this[t+r+1]&&(a=1),this[t+r]=(e/s>>0)-a&255;return t+n},ae.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,1,127,-128),ae.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},ae.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,2,32767,-32768),ae.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):Pe(this,e,t,!0),t+2},ae.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,2,32767,-32768),ae.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):Pe(this,e,t,!1),t+2},ae.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,4,2147483647,-2147483648),ae.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):Me(this,e,t,!0),t+4},ae.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||Oe(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),ae.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):Me(this,e,t,!1),t+4},ae.prototype.writeFloatLE=function(e,t,n){return Le(this,e,t,!0,n)},ae.prototype.writeFloatBE=function(e,t,n){return Le(this,e,t,!1,n)},ae.prototype.writeDoubleLE=function(e,t,n){return $e(this,e,t,!0,n)},ae.prototype.writeDoubleBE=function(e,t,n){return $e(this,e,t,!1,n)},ae.prototype.copy=function(e,t,n,o){if(n||(n=0),o||0===o||(o=this.length),t>=e.length&&(t=e.length),t||(t=0),o>0&&o<n&&(o=n),o===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(o<0)throw new RangeError("sourceEnd out of bounds");o>this.length&&(o=this.length),e.length-t<o-n&&(o=e.length-t+n);var i,r=o-n;if(this===e&&n<t&&t<o)for(i=r-1;i>=0;--i)e[i+t]=this[i+n];else if(r<1e3||!ae.TYPED_ARRAY_SUPPORT)for(i=0;i<r;++i)e[i+t]=this[i+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+r),t);return r},ae.prototype.fill=function(e,t,n,o){if("string"==typeof e){if("string"==typeof t?(o=t,t=0,n=this.length):"string"==typeof n&&(o=n,n=this.length),1===e.length){var i=e.charCodeAt(0);i<256&&(e=i)}if(void 0!==o&&"string"!=typeof o)throw new TypeError("encoding must be a string");if("string"==typeof o&&!ae.isEncoding(o))throw new TypeError("Unknown encoding: "+o)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var r;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(r=t;r<n;++r)this[r]=e;else{var s=ge(e)?e:Ye(new ae(e,o).toString()),a=s.length;for(r=0;r<n-t;++r)this[r+t]=s[r%a]}return this};var He=/[^+\/0-9A-Za-z-_]/g;function Ue(e){return e<16?"0"+e.toString(16):e.toString(16)}function Ye(e,t){var n;t=t||1/0;for(var o=e.length,i=null,r=[],s=0;s<o;++s){if((n=e.charCodeAt(s))>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&r.push(239,191,189);continue}if(s+1===o){(t-=3)>-1&&r.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&r.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&r.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;r.push(n)}else if(n<2048){if((t-=2)<0)break;r.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;r.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;r.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return r}function Fe(e){return function(e){var t,n,o,i,r,s;q||X();var a=e.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");r="="===e[a-2]?2:"="===e[a-1]?1:0,s=new Z(3*a/4-r),o=r>0?a-4:a;var c=0;for(t=0,n=0;t<o;t+=4,n+=3)i=J[e.charCodeAt(t)]<<18|J[e.charCodeAt(t+1)]<<12|J[e.charCodeAt(t+2)]<<6|J[e.charCodeAt(t+3)],s[c++]=i>>16&255,s[c++]=i>>8&255,s[c++]=255&i;return 2===r?(i=J[e.charCodeAt(t)]<<2|J[e.charCodeAt(t+1)]>>4,s[c++]=255&i):1===r&&(i=J[e.charCodeAt(t)]<<10|J[e.charCodeAt(t+1)]<<4|J[e.charCodeAt(t+2)]>>2,s[c++]=i>>8&255,s[c++]=255&i),s}(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(He,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function je(e,t,n,o){for(var i=0;i<o&&!(i+n>=t.length||i>=e.length);++i)t[i+n]=e[i];return i}function ze(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}class Be{constructor(e){this.enabled=!0,(null==e?void 0:e.debug)&&L.enable("Ecies:Layer"),(null==e?void 0:e.privateKey)?this.ecies=n.PrivateKey.fromHex(e.privateKey):this.ecies=new n.PrivateKey,F.Ecies("[ECIES constructor()] initialized secret: ",this.ecies.toHex()),F.Ecies("[ECIES constructor()] initialized public: ",this.ecies.publicKey.toHex()),F.Ecies("[ECIES constructor()] init with",this)}generateECIES(){this.ecies=new n.PrivateKey}getPublicKey(){return this.ecies.publicKey.toHex()}encrypt(e,t){let o=e;if(this.enabled)try{F.Ecies("[ECIES: encrypt()] using otherPublicKey",t);const i=ae.from(e),r=n.encrypt(t,i);o=ae.from(r).toString("base64")}catch(n){throw F.Ecies("[ECIES: encrypt()] error encrypt:",n),F.Ecies("[ECIES: encrypt()] private: ",this.ecies.toHex()),F.Ecies("[ECIES: encrypt()] data: ",e),F.Ecies("[ECIES: encrypt()] otherkey: ",t),n}return o}decrypt(e){let t=e;if(this.enabled)try{F.Ecies("[ECIES: decrypt()] using privateKey",this.ecies.toHex());const o=ae.from(e.toString(),"base64");t=n.decrypt(this.ecies.toHex(),o).toString()}catch(t){throw F.Ecies("[ECIES: decrypt()] error decrypt",t),F.Ecies("[ECIES: decrypt()] private: ",this.ecies.toHex()),F.Ecies("[ECIES: decrypt()] encryptedData: ",e),t}return t}getKeyInfo(){return{private:this.ecies.toHex(),public:this.ecies.publicKey.toHex()}}toString(){F.Ecies("[ECIES: toString()]",this.getKeyInfo())}}var Ve={name:"@metamask/sdk-communication-layer",version:"0.30.0",description:"",homepage:"https://github.com/MetaMask/metamask-sdk#readme",bugs:{url:"https://github.com/MetaMask/metamask-sdk/issues"},repository:{type:"git",url:"https://github.com/MetaMask/metamask-sdk.git",directory:"packages/sdk-communication-layer"},main:"dist/node/cjs/metamask-sdk-communication-layer.js",unpkg:"dist/browser/umd/metamask-sdk-communication-layer.js",module:"dist/node/es/metamask-sdk-communication-layer.js",browser:"dist/browser/es/metamask-sdk-communication-layer.js","react-native":"dist/react-native/es/metamask-sdk-communication-layer.js",types:"dist/browser/es/src/index.d.ts",files:["/dist"],scripts:{build:"rimraf dist && rollup -c --bundleConfigAsCjs","build:tsc":"tsc","build:dev":"rimraf dist && NODE_ENV=dev rollup -c --bundleConfigAsCjs","build:post-tsc":"echo 'N/A'","build:pre-tsc":"echo 'N/A'",size:"size-limit",clean:"rimraf ./dist",lint:"yarn lint:eslint && yarn lint:misc --check","lint:changelog":"../../scripts/validate-changelog.sh @metamask/sdk-communication-layer","lint:eslint":"eslint . --cache --ext js,ts","lint:fix":"yarn lint:eslint --fix && yarn lint:misc --write","lint:misc":"prettier '**/*.json' '**/*.md' '!CHANGELOG.md' --ignore-path ../../.gitignore","publish:preview":"yarn npm publish --tag preview",prepack:"../../scripts/prepack.sh",reset:"yarn clean && rimraf ./node_modules/",test:'jest --testPathIgnorePatterns "/e2e/"',"test:e2e":'jest --testPathPattern "/e2e/"',"test:coverage":"jest --coverage","test:ci":'jest --coverage --passWithNoTests --setupFilesAfterEnv ./jest-preload.js --testPathIgnorePatterns "/e2e/"',"test:dev":"jest",watch:"rollup -c --bundleConfigAsCjs -w"},dependencies:{bufferutil:"^4.0.8","date-fns":"^2.29.3",debug:"^4.3.4","utf-8-validate":"^5.0.2",uuid:"^8.3.2"},devDependencies:{"@jest/globals":"^29.3.1","@lavamoat/allow-scripts":"^2.3.1","@metamask/auto-changelog":"3.1.0","@metamask/eslint-config":"^6.0.0","@metamask/eslint-config-nodejs":"^6.0.0","@metamask/eslint-config-typescript":"^6.0.0","@rollup/plugin-commonjs":"^25.0.0","@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.2","@rollup/plugin-terser":"^0.4.1","@size-limit/preset-big-lib":"^11.0.2","@types/jest":"^29.2.4","@types/node":"^20.1.3","@types/uuid":"^9.0.0","@typescript-eslint/eslint-plugin":"^4.26.0","@typescript-eslint/parser":"^4.26.0","cross-fetch":"^4.0.0",eciesjs:"^0.3.16",eslint:"^7.30.0","eslint-config-prettier":"^8.3.0","eslint-plugin-import":"^2.23.4","eslint-plugin-jest":"^24.4.0","eslint-plugin-jsdoc":"^36.1.0","eslint-plugin-node":"^11.1.0","eslint-plugin-prettier":"^3.4.0",eventemitter2:"^6.4.7",jest:"^29.3.1",prettier:"^2.3.0",rimraf:"^3.0.2",rollup:"^3.21.7","rollup-plugin-jscc":"^2.0.0","rollup-plugin-natives":"^0.7.5","rollup-plugin-node-builtins":"^2.1.2","rollup-plugin-node-globals":"^1.4.0","rollup-plugin-peer-deps-external":"^2.2.4","rollup-plugin-sizes":"^1.0.6","rollup-plugin-typescript2":"^0.31.2","rollup-plugin-visualizer":"^5.9.2","size-limit":"^11.0.2","socket.io-client":"^4.5.1","stream-browserify":"^3.0.0","ts-jest":"^29.0.3","ts-node":"^10.9.1",typescript:"^4.3.2"},peerDependencies:{"cross-fetch":"^4.0.0",eciesjs:"^0.3.16",eventemitter2:"^6.4.7","readable-stream":"^3.6.2","socket.io-client":"^4.5.1"},publishConfig:{access:"public",registry:"https://registry.npmjs.org/"},lavamoat:{allowScripts:{"@lavamoat/preinstall-always-fail":!1,canvas:!0,"eciesjs>secp256k1":!1,"socket.io-client>engine.io-client>ws>bufferutil":!1,"socket.io-client>engine.io-client>ws>utf-8-validate":!1,bufferutil:!1,"utf-8-validate":!1}}};const Ge="https://metamask-sdk.api.cx.metamask.io/",We=["websocket"],Je=6048e5,Ze=3e3,qe={METAMASK_GETPROVIDERSTATE:"metamask_getProviderState",ETH_REQUESTACCOUNTS:"eth_requestAccounts"};function Xe(e){const{context:t}=e;F.RemoteCommunication(`[RemoteCommunication: clean()] context=${t}`),e.channelConfig=void 0,e.ready=!1,e.originatorConnectStarted=!1}var Qe,et=new Uint8Array(16);function tt(){if(!Qe&&!(Qe="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Qe(et)}var nt=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function ot(e){return"string"==typeof e&&nt.test(e)}for(var it,rt,st,at,ct,lt,ut=[],dt=0;dt<256;++dt)ut.push((dt+256).toString(16).substr(1));function ht(e,t,n){var o=(e=e||{}).random||(e.rng||tt)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){n=n||0;for(var i=0;i<16;++i)t[n+i]=o[i];return t}return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=(ut[e[t+0]]+ut[e[t+1]]+ut[e[t+2]]+ut[e[t+3]]+"-"+ut[e[t+4]]+ut[e[t+5]]+"-"+ut[e[t+6]]+ut[e[t+7]]+"-"+ut[e[t+8]]+ut[e[t+9]]+"-"+ut[e[t+10]]+ut[e[t+11]]+ut[e[t+12]]+ut[e[t+13]]+ut[e[t+14]]+ut[e[t+15]]).toLowerCase();if(!ot(n))throw TypeError("Stringified UUID is invalid");return n}(o)}e.ConnectionStatus=void 0,(it=e.ConnectionStatus||(e.ConnectionStatus={})).DISCONNECTED="disconnected",it.WAITING="waiting",it.TIMEOUT="timeout",it.LINKED="linked",it.PAUSED="paused",it.TERMINATED="terminated",e.EventType=void 0,(rt=e.EventType||(e.EventType={})).KEY_INFO="key_info",rt.SERVICE_STATUS="service_status",rt.PROVIDER_UPDATE="provider_update",rt.RPC_UPDATE="rpc_update",rt.KEYS_EXCHANGED="keys_exchanged",rt.JOIN_CHANNEL="join_channel",rt.PUBLIC_KEY="public_key",rt.CHANNEL_CREATED="channel_created",rt.CLIENTS_CONNECTED="clients_connected",rt.CLIENTS_DISCONNECTED="clients_disconnected",rt.CLIENTS_WAITING="clients_waiting",rt.CLIENTS_READY="clients_ready",rt.REJECTED="rejected",rt.WALLET_INIT="wallet_init",rt.CHANNEL_PERSISTENCE="channel_persistence",rt.CONFIG="config",rt.MESSAGE_ACK="ack",rt.SOCKET_DISCONNECTED="socket_disconnected",rt.SOCKET_RECONNECT="socket_reconnect",rt.OTP="otp",rt.SDK_RPC_CALL="sdk_rpc_call",rt.AUTHORIZED="authorized",rt.CONNECTION_STATUS="connection_status",rt.MESSAGE="message",rt.TERMINATE="terminate",function(e){e.KEY_EXCHANGE="key_exchange"}(st||(st={})),e.KeyExchangeMessageType=void 0,(at=e.KeyExchangeMessageType||(e.KeyExchangeMessageType={})).KEY_HANDSHAKE_START="key_handshake_start",at.KEY_HANDSHAKE_CHECK="key_handshake_check",at.KEY_HANDSHAKE_SYN="key_handshake_SYN",at.KEY_HANDSHAKE_SYNACK="key_handshake_SYNACK",at.KEY_HANDSHAKE_ACK="key_handshake_ACK",at.KEY_HANDSHAKE_WALLET="key_handshake_wallet",at.KEY_HANDSHAKE_NONE="none";class gt extends o.EventEmitter2{constructor({communicationLayer:t,otherPublicKey:n,context:o,ecies:i,logging:r}){super(),this.keysExchanged=!1,this.step=e.KeyExchangeMessageType.KEY_HANDSHAKE_NONE,this.debug=!1,this.context=o,this.communicationLayer=t,(null==i?void 0:i.privateKey)&&n&&(F.KeyExchange(`[KeyExchange: constructor()] otherPubKey=${n} set keysExchanged to true!`,i),this.keysExchanged=!0),this.myECIES=new Be(Object.assign(Object.assign({},i),{debug:null==r?void 0:r.eciesLayer})),this.communicationLayer.state.eciesInstance=this.myECIES,this.myPublicKey=this.myECIES.getPublicKey(),this.debug=!0===(null==r?void 0:r.keyExchangeLayer),n&&this.setOtherPublicKey(n),this.communicationLayer.on(st.KEY_EXCHANGE,this.onKeyExchangeMessage.bind(this))}onKeyExchangeMessage(t){const{relayPersistence:n}=this.communicationLayer.remote.state;if(F.KeyExchange(`[KeyExchange: onKeyExchangeMessage()] context=${this.context} keysExchanged=${this.keysExchanged} relayPersistence=${n}`,t),n)return void F.KeyExchange("[KeyExchange: onKeyExchangeMessage()] Ignoring key exchange message because relay persistence is activated");const{message:o}=t;this.keysExchanged&&F.KeyExchange(`[KeyExchange: onKeyExchangeMessage()] context=${this.context} received handshake while already exchanged. step=${this.step} otherPubKey=${this.otherPublicKey}`),this.emit(e.EventType.KEY_INFO,o.type),o.type===e.KeyExchangeMessageType.KEY_HANDSHAKE_SYN?(this.checkStep([e.KeyExchangeMessageType.KEY_HANDSHAKE_NONE,e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK]),F.KeyExchange("[KeyExchange: onKeyExchangeMessage()] KEY_HANDSHAKE_SYN",o),o.pubkey&&this.setOtherPublicKey(o.pubkey),this.communicationLayer.sendMessage({type:e.KeyExchangeMessageType.KEY_HANDSHAKE_SYNACK,pubkey:this.myPublicKey}).catch((e=>{F.KeyExchange("[KeyExchange: onKeyExchangeMessage()] Error sending KEY_HANDSHAKE_SYNACK",e)})),this.setStep(e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK)):o.type===e.KeyExchangeMessageType.KEY_HANDSHAKE_SYNACK?(this.checkStep([e.KeyExchangeMessageType.KEY_HANDSHAKE_SYNACK,e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK,e.KeyExchangeMessageType.KEY_HANDSHAKE_NONE]),F.KeyExchange("[KeyExchange: onKeyExchangeMessage()] KEY_HANDSHAKE_SYNACK"),o.pubkey&&this.setOtherPublicKey(o.pubkey),this.communicationLayer.sendMessage({type:e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK}).catch((e=>{F.KeyExchange("[KeyExchange: onKeyExchangeMessage()] Error sending KEY_HANDSHAKE_ACK",e)})),this.keysExchanged=!0,this.setStep(e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK),this.emit(e.EventType.KEYS_EXCHANGED)):o.type===e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK&&(F.KeyExchange("[KeyExchange: onKeyExchangeMessage()] KEY_HANDSHAKE_ACK set keysExchanged to true!"),this.checkStep([e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK,e.KeyExchangeMessageType.KEY_HANDSHAKE_NONE]),this.keysExchanged=!0,this.setStep(e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK),this.emit(e.EventType.KEYS_EXCHANGED))}resetKeys(e){this.clean(),this.myECIES=new Be(e)}clean(){F.KeyExchange(`[KeyExchange: clean()] context=${this.context} reset handshake state`),this.setStep(e.KeyExchangeMessageType.KEY_HANDSHAKE_NONE),this.emit(e.EventType.KEY_INFO,this.step),this.keysExchanged=!1}start({isOriginator:t,force:n}){const{relayPersistence:o,protocolVersion:i}=this.communicationLayer.remote.state,r=i>=2;if(o)return F.KeyExchange("[KeyExchange: start()] Ignoring key exchange message because relay persistence is activated"),void console.log(`[KeyExchange: start()] relayPersistence=${o}`);F.KeyExchange(`[KeyExchange: start()] context=${this.context} protocolVersion=${i} isOriginator=${t} step=${this.step} force=${n} relayPersistence=${o} keysExchanged=${this.keysExchanged}`),t?!(this.keysExchanged||this.step!==e.KeyExchangeMessageType.KEY_HANDSHAKE_NONE&&this.step!==e.KeyExchangeMessageType.KEY_HANDSHAKE_SYNACK)||n?(F.KeyExchange(`[KeyExchange: start()] context=${this.context} -- start key exchange (force=${n}) -- step=${this.step}`,this.step),this.clean(),this.setStep(e.KeyExchangeMessageType.KEY_HANDSHAKE_SYNACK),this.communicationLayer.sendMessage({type:e.KeyExchangeMessageType.KEY_HANDSHAKE_SYN,pubkey:this.myPublicKey,v:2}).catch((e=>{F.KeyExchange("[KeyExchange: start()] Error sending KEY_HANDSHAKE_SYN",e)}))):F.KeyExchange(`[KeyExchange: start()] context=${this.context} -- key exchange already ${this.keysExchanged?"done":"in progress"} -- aborted.`,this.step):this.keysExchanged&&!0!==n?F.KeyExchange("[KeyExchange: start()] don't send KEY_HANDSHAKE_START -- exchange already done."):r?this.communicationLayer.sendMessage({type:e.KeyExchangeMessageType.KEY_HANDSHAKE_SYNACK,pubkey:this.myPublicKey,v:2}).catch((e=>{F.KeyExchange("[KeyExchange: start()] Error sending KEY_HANDSHAKE_SYNACK",e)})):(this.communicationLayer.sendMessage({type:e.KeyExchangeMessageType.KEY_HANDSHAKE_START}).catch((e=>{F.KeyExchange("[KeyExchange: start()] Error sending KEY_HANDSHAKE_START",e)})),this.clean())}setStep(t){this.step=t,this.emit(e.EventType.KEY_INFO,t)}checkStep(e){e.length>0&&-1===e.indexOf(this.step.toString())&&console.warn(`[KeyExchange: checkStep()]  Wrong Step "${this.step}" not within ${e}`)}setRelayPersistence({localKey:e,otherKey:t}){this.otherPublicKey=t,this.myECIES=new Be({privateKey:e,debug:this.debug}),this.keysExchanged=!0}setKeysExchanged(e){this.keysExchanged=e}areKeysExchanged(){return this.keysExchanged}getMyPublicKey(){return this.myPublicKey}getOtherPublicKey(){return this.otherPublicKey}setOtherPublicKey(e){F.KeyExchange("[KeyExchange: setOtherPubKey()]",e),this.otherPublicKey=e}encryptMessage(e){if(!this.otherPublicKey)throw new Error("encryptMessage: Keys not exchanged - missing otherPubKey");return this.myECIES.encrypt(e,this.otherPublicKey)}decryptMessage(e){if(!this.otherPublicKey)throw new Error("decryptMessage: Keys not exchanged - missing otherPubKey");return this.myECIES.decrypt(e)}getKeyInfo(){return{ecies:Object.assign(Object.assign({},this.myECIES.getKeyInfo()),{otherPubKey:this.otherPublicKey}),step:this.step,keysExchanged:this.areKeysExchanged()}}toString(){const e={keyInfo:this.getKeyInfo(),keysExchanged:this.keysExchanged,step:this.step};return JSON.stringify(e)}}e.MessageType=void 0,(ct=e.MessageType||(e.MessageType={})).TERMINATE="terminate",ct.ANSWER="answer",ct.OFFER="offer",ct.CANDIDATE="candidate",ct.JSONRPC="jsonrpc",ct.WALLET_INFO="wallet_info",ct.WALLET_INIT="wallet_init",ct.ORIGINATOR_INFO="originator_info",ct.PAUSE="pause",ct.OTP="otp",ct.AUTHORIZED="authorized",ct.PING="ping",ct.READY="ready",e.TrackingEvents=void 0,(lt=e.TrackingEvents||(e.TrackingEvents={})).REQUEST="sdk_connect_request_started",lt.REQUEST_MOBILE="sdk_connect_request_started_mobile",lt.RECONNECT="sdk_reconnect_request_started",lt.CONNECTED="sdk_connection_established",lt.CONNECTED_MOBILE="sdk_connection_established_mobile",lt.AUTHORIZED="sdk_connection_authorized",lt.REJECTED="sdk_connection_rejected",lt.TERMINATED="sdk_connection_terminated",lt.DISCONNECTED="sdk_disconnected",lt.SDK_USE_EXTENSION="sdk_use_extension",lt.SDK_RPC_REQUEST="sdk_rpc_request",lt.SDK_RPC_REQUEST_RECEIVED="sdk_rpc_request_received",lt.SDK_RPC_REQUEST_DONE="sdk_rpc_request_done",lt.SDK_EXTENSION_UTILIZED="sdk_extension_utilized",lt.SDK_USE_INAPP_BROWSER="sdk_use_inapp_browser";const yt=(t,n,o)=>r(void 0,void 0,void 0,(function*(){var i,r,s,a,c,l;const{remote:u,state:d}=t,{channelId:h,isOriginator:g}=d;if("error_terminated"===n)return F.SocketService(`handleJoinChannelResults: Channel ${h} terminated`),void t.emit(e.EventType.TERMINATE);if(!o)return void F.SocketService(`handleJoinChannelResults: No result for channel ${h}`);const{persistence:y,walletKey:m,rejected:v}=o;if(F.SocketService(`handleJoinChannelResults: Channel ${h} persistence=${y} walletKey=${m} rejected=${v}`),v)return F.SocketService(`handleJoinChannelResults: Channel ${h} rejected`),yield t.remote.disconnect({terminate:!0}),t.remote.emit(e.EventType.REJECTED,{channelId:h}),void t.remote.emitServiceStatusEvent();if(m&&!(null===(i=u.state.channelConfig)||void 0===i?void 0:i.otherKey)){t.getKeyExchange().setOtherPublicKey(m),null===(r=t.state.keyExchange)||void 0===r||r.setKeysExchanged(!0),u.state.ready=!0,u.state.authorized=!0,u.emit(e.EventType.AUTHORIZED);const{communicationLayer:n,storageManager:o}=u.state,i=Object.assign(Object.assign({},u.state.channelConfig),{channelId:null!==(s=u.state.channelId)&&void 0!==s?s:"",validUntil:Date.now()+Je,localKey:null==n?void 0:n.getKeyInfo().ecies.private,otherKey:m});t.sendMessage({type:e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK}).catch((e=>{console.error(e)})),null===(a=t.state.socket)||void 0===a||a.emit(e.MessageType.PING,{id:h,clientType:g?"dapp":"wallet",context:"on_channel_reconnect",message:""}),yield null==o?void 0:o.persistChannelConfig(i),u.emitServiceStatusEvent(),u.setConnectionStatus(e.ConnectionStatus.LINKED)}y&&(t.emit(e.EventType.CHANNEL_PERSISTENCE),null===(c=t.state.keyExchange)||void 0===c||c.setKeysExchanged(!0),u.state.ready=!0,u.state.authorized=!0,u.emit(e.EventType.AUTHORIZED),G(Object.assign(Object.assign({id:null!=h?h:"",event:g?e.TrackingEvents.CONNECTED:e.TrackingEvents.CONNECTED_MOBILE},t.remote.state.originatorInfo),{sdkVersion:t.remote.state.sdkVersion,commLayer:t.state.communicationLayerPreference,commLayerVersion:Ve.version,walletVersion:null===(l=t.remote.state.walletInfo)||void 0===l?void 0:l.version}),d.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)})))}));const mt=e=>new Promise((t=>{setTimeout(t,e)})),vt=(e,t,n=200)=>r(void 0,void 0,void 0,(function*(){let o;const i=Date.now();let r=!1;for(;!r;){if(r=Date.now()-i>3e5,o=t[e],void 0!==o.elapsedTime)return o;yield mt(n)}throw new Error(`RPC ${e} timed out`)})),ft=({rpcId:e,instance:t})=>r(void 0,void 0,void 0,(function*(){for(;t.state.lastRpcId===e||void 0===t.state.lastRpcId;)yield mt(200);return t.state.lastRpcId})),pt=t=>r(void 0,void 0,void 0,(function*(){const{state:n}=t,{socket:o,channelId:i,context:s,isOriginator:a,isReconnecting:c}=n;if(c)return F.SocketService("[SocketService: reconnectSocket()] Reconnection already in progress, skipping",t),!1;if(!o)return F.SocketService("[SocketService: reconnectSocket()] socket is not defined",t),!1;if(!i)return!1;const{connected:l}=o;n.isReconnecting=!0,n.reconnectionAttempts=0,F.SocketService(`[SocketService: reconnectSocket()] connected=${l} trying to reconnect after socketio disconnection`,t);try{for(;n.reconnectionAttempts<3;){if(F.SocketService(`[SocketService: reconnectSocket()] Attempt ${n.reconnectionAttempts+1} of 3`,t),yield mt(200),o.connected)return F.SocketService("Socket already connected --- ping to retrieve messages"),o.emit(e.MessageType.PING,{id:i,clientType:a?"dapp":"wallet",context:"on_channel_config",message:""}),!0;n.resumed=!0,o.connect(),t.emit(e.EventType.SOCKET_RECONNECT);try{if(yield new Promise(((n,c)=>{o.emit(e.EventType.JOIN_CHANNEL,{channelId:i,context:`${s}connect_again`,clientType:a?"dapp":"wallet"},((e,o)=>r(void 0,void 0,void 0,(function*(){try{yield yt(t,e,o),n()}catch(e){c(e)}}))))})),yield mt(100),o.connected)return F.SocketService(`Reconnection successful on attempt ${n.reconnectionAttempts+1}`),!0}catch(e){F.SocketService(`Error during reconnection attempt ${n.reconnectionAttempts+1}:`,e)}n.reconnectionAttempts+=1,n.reconnectionAttempts<3&&(yield mt(200))}return F.SocketService("Failed to reconnect after 3 attempts"),!1}finally{n.isReconnecting=!1,n.reconnectionAttempts=0}}));function Et(t,n){var o;return r(this,void 0,void 0,(function*(){const i=null===(o=t.state.keyExchange)||void 0===o?void 0:o.encryptMessage(JSON.stringify(n)),r={id:t.state.channelId,context:t.state.context,clientType:t.state.isOriginator?"dapp":"wallet",message:i,plaintext:t.state.hasPlaintext?JSON.stringify(n):void 0};return F.SocketService(`[SocketService: encryptAndSendMessage()] context=${t.state.context}`,r),n.type===e.MessageType.TERMINATE&&(t.state.manualDisconnect=!0),new Promise(((n,o)=>{var i;null===(i=t.state.socket)||void 0===i||i.emit(e.EventType.MESSAGE,r,((e,t)=>{var i;e&&(F.SocketService(`[SocketService: encryptAndSendMessage()] error=${e}`),o(e)),F.SocketService("[encryptAndSendMessage] response",t),n(null!==(i=null==t?void 0:t.success)&&void 0!==i&&i)}))}))}))}const Ct="SDK_CONNECTION_ISSUE";var St;!function(e){e.RPC_CHECK="rpcCheck",e.SKIPPED_RPC="skippedRpc"}(St||(St={}));const Tt=["eth_sendTransaction","eth_signTypedData","eth_signTransaction","personal_sign","wallet_requestPermissions","wallet_switchEthereumChain","eth_signTypedData_v3","eth_signTypedData_v4","metamask_connectSign","metamask_connectWith","metamask_batch"].map((e=>e.toLowerCase()));function kt(t,n){var o,i,s;return r(this,void 0,void 0,(function*(){if(!t.state.channelId)throw F.SocketService("handleSendMessage: no channelId - Create a channel first"),new Error("Create a channel first");F.SocketService(`[SocketService: handleSendMessage()] context=${t.state.context} areKeysExchanged=${null===(o=t.state.keyExchange)||void 0===o?void 0:o.areKeysExchanged()}`,n);if(null===(i=null==n?void 0:n.type)||void 0===i?void 0:i.startsWith("key_handshake"))return function(t,n){var o;F.SocketService(`[SocketService: handleKeyHandshake()] context=${t.state.context}`,n),null===(o=t.state.socket)||void 0===o||o.emit(e.EventType.MESSAGE,{id:t.state.channelId,context:t.state.context,clientType:t.state.isOriginator?"dapp":"wallet",message:n})}(t,n),!0;!function(e,t){var n;if(!(null===(n=e.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged())&&!e.remote.state.relayPersistence)throw F.SocketService(`[SocketService: validateKeyExchange()] context=${e.state.context} ERROR keys not exchanged`,t),console.error("[SocketService: validateKeyExchange()] ERROR keys not exchanged",t),new Error("Keys not exchanged BBB")}(t,n),function(t,n){var o;const i=null!==(o=null==n?void 0:n.method)&&void 0!==o?o:"",r=null==n?void 0:n.id;t.state.isOriginator&&r&&(t.state.rpcMethodTracker[r]={id:r,timestamp:Date.now(),method:i},t.emit(e.EventType.RPC_UPDATE,t.state.rpcMethodTracker[r]))}(t,n);const a=yield Et(t,n);return t.remote.state.analytics&&t.remote.state.isOriginator&&n.method&&Tt.includes(n.method.toLowerCase())&&G({id:null!==(s=t.remote.state.channelId)&&void 0!==s?s:"",event:e.TrackingEvents.SDK_RPC_REQUEST,params:{method:n.method,from:"mobile"}},t.remote.state.communicationServerUrl).catch((e=>{console.error("[handleSendMessage] Cannot send analytics",e)})),function(t,n){var o;return r(this,void 0,void 0,(function*(){const i=null==n?void 0:n.id,s=null!==(o=null==n?void 0:n.method)&&void 0!==o?o:"";if(t.state.isOriginator&&i)try{const o=vt(i,t.state.rpcMethodTracker,200).then((e=>({type:St.RPC_CHECK,result:e}))),a=(()=>r(this,void 0,void 0,(function*(){const e=yield ft({instance:t,rpcId:i}),n=yield vt(e,t.state.rpcMethodTracker,200);return{type:St.SKIPPED_RPC,result:n}})))(),c=yield Promise.race([o,a]);if(c.type===St.RPC_CHECK){const e=c.result;F.SocketService(`[SocketService:handleRpcReplies()] id=${n.id} ${s} ( ${e.elapsedTime} ms)`,e.result)}else{if(c.type!==St.SKIPPED_RPC)throw new Error(`Error handling RPC replies for ${i}`);{const{result:n}=c;console.warn(`[SocketService handleRpcReplies()] RPC METHOD HAS BEEN SKIPPED rpcid=${i} method=${s}`,n);const o=Object.assign(Object.assign({},t.state.rpcMethodTracker[i]),{error:new Error(Ct)});t.emit(e.EventType.RPC_UPDATE,o);const r={data:Object.assign(Object.assign({},o),{jsonrpc:"2.0"}),name:"metamask-provider"};t.emit(e.EventType.MESSAGE,{message:r})}}}catch(e){throw console.warn(`[SocketService handleRpcReplies()] Error rpcId=${n.id} ${s}`,e),e}}))}(t,n).catch((e=>{console.warn("[handleSendMessage] Error handleRpcReplies",e)})),a}))}const xt=[{event:e.EventType.CLIENTS_CONNECTED,handler:function(t,n){return o=>r(this,void 0,void 0,(function*(){var o,i,r,s,a,c,l,u,d,h,g;const y=null!==(i=null===(o=t.remote.state.channelConfig)||void 0===o?void 0:o.relayPersistence)&&void 0!==i&&i;if(F.SocketService(`[SocketService: handleClientsConnected()] context=${t.state.context} on 'clients_connected-${n}' relayPersistence=${y} resumed=${t.state.resumed}  clientsPaused=${t.state.clientsPaused} keysExchanged=${null===(r=t.state.keyExchange)||void 0===r?void 0:r.areKeysExchanged()} isOriginator=${t.state.isOriginator}`),t.emit(e.EventType.CLIENTS_CONNECTED,{isOriginator:t.state.isOriginator,keysExchanged:null===(s=t.state.keyExchange)||void 0===s?void 0:s.areKeysExchanged(),context:t.state.context}),t.state.resumed)t.state.isOriginator||(F.SocketService(`[SocketService: handleClientsConnected()] context=${t.state.context} 'clients_connected' / keysExchanged=${null===(a=t.state.keyExchange)||void 0===a?void 0:a.areKeysExchanged()} -- backward compatibility`),null===(c=t.state.keyExchange)||void 0===c||c.start({isOriginator:null!==(l=t.state.isOriginator)&&void 0!==l&&l})),t.state.resumed=!1;else if(t.state.clientsPaused)F.SocketService("[SocketService: handleClientsConnected()] 'clients_connected' skip sending originatorInfo on pause");else if(!t.state.isOriginator){const e=!y;F.SocketService(`[SocketService: handleClientsConnected()] context=${t.state.context} on 'clients_connected' / keysExchanged=${null===(u=t.state.keyExchange)||void 0===u?void 0:u.areKeysExchanged()} -- force=${e} -- backward compatibility`),F.SocketService(`[SocketService: handleClientsConnected()] context=${t.state.context} on 'clients_connected' / keysExchanged=${null===(d=t.state.keyExchange)||void 0===d?void 0:d.areKeysExchanged()} -- force=${e} -- backward compatibility`),null===(h=t.state.keyExchange)||void 0===h||h.start({isOriginator:null!==(g=t.state.isOriginator)&&void 0!==g&&g,force:e})}t.state.clientsConnected=!0,t.state.clientsPaused=!1}))}},{event:e.EventType.CHANNEL_CREATED,handler:function(t,n){return o=>{F.SocketService(`[SocketService: handleChannelCreated()] context=${t.state.context} on 'channel_created-${n}'`,o),t.emit(e.EventType.CHANNEL_CREATED,o)}}},{event:e.EventType.CLIENTS_DISCONNECTED,handler:function(t,n){return()=>{var o;t.state.clientsConnected=!1,F.SocketService(`[SocketService: handlesClientsDisconnected()] context=${t.state.context} on 'clients_disconnected-${n}'`),t.remote.state.relayPersistence?F.SocketService(`[SocketService: handlesClientsDisconnected()] context=${t.state.context} on 'clients_disconnected-${n}' - relayPersistence enabled, skipping key exchange cleanup.`):(t.state.isOriginator&&!t.state.clientsPaused&&(null===(o=t.state.keyExchange)||void 0===o||o.clean()),t.emit(e.EventType.CLIENTS_DISCONNECTED,n))}}},{event:e.EventType.CONFIG,handler:function(t,n){return o=>r(this,void 0,void 0,(function*(){var i,r,s;F.SocketService(`[SocketService: handleChannelConfig()] update relayPersistence on 'config-${n}'`,o);const{persistence:a,walletKey:c}=o;t.state.isOriginator&&t.remote.state.channelConfig?(o.walletKey&&!t.remote.state.channelConfig.otherKey&&(F.SocketService(`Setting wallet key ${c}`),t.remote.state.channelConfig.otherKey=c,t.getKeyExchange().setOtherPublicKey(o.walletKey),null===(i=t.state.keyExchange)||void 0===i||i.setKeysExchanged(!0),yield t.remote.sendMessage({type:e.KeyExchangeMessageType.KEY_HANDSHAKE_ACK}),yield t.remote.sendMessage({type:e.MessageType.PING}),yield null===(r=t.remote.state.storageManager)||void 0===r?void 0:r.persistChannelConfig(t.remote.state.channelConfig)),!0!==a||t.remote.state.channelConfig.relayPersistence||(F.SocketService(`Setting relay persistence ${a}`),t.remote.state.channelConfig.relayPersistence=a,t.remote.state.relayPersistence=!0,t.remote.emit(e.EventType.CHANNEL_PERSISTENCE),t.remote.state.authorized=!0,t.remote.state.ready=!0,t.remote.emit(e.EventType.AUTHORIZED),yield null===(s=t.remote.state.storageManager)||void 0===s?void 0:s.persistChannelConfig(t.remote.state.channelConfig))):t.state.isOriginator||o.persistence&&(t.remote.state.relayPersistence=!0,t.remote.emit(e.EventType.CHANNEL_PERSISTENCE))}))}},{event:e.EventType.MESSAGE,handler:function(t,n){return o=>{var i,r,s,a,c,l,u,d,h,g,y,m,v,f,p,E,C,S;const{ackId:T,message:k,error:x}=o,K=null!==(i=t.remote.state.relayPersistence)&&void 0!==i&&i;if(F.SocketService(`[SocketService handleMessage()]  relayPersistence=${K}  context=${t.state.context} on 'message' ${n} keysExchanged=${null===(r=t.state.keyExchange)||void 0===r?void 0:r.areKeysExchanged()}`,o),x)throw F.SocketService(`\n      [SocketService handleMessage()] context=${t.state.context}::on 'message' error=${x}`),new Error(x);const I="string"==typeof k;if(!I&&(null==k?void 0:k.type)===e.KeyExchangeMessageType.KEY_HANDSHAKE_START)return K?void console.warn("[SocketService handleMessage()] Ignoring key exchange message because relay persistence is activated",k):(F.SocketService(`[SocketService handleMessage()] context=${t.state.context}::on 'message' received HANDSHAKE_START isOriginator=${t.state.isOriginator}`,k),void(null===(s=t.state.keyExchange)||void 0===s||s.start({isOriginator:null!==(a=t.state.isOriginator)&&void 0!==a&&a,force:!0})));if(!I&&(null===(c=null==k?void 0:k.type)||void 0===c?void 0:c.startsWith("key_handshake")))return K?void console.warn("[SocketService handleMessage()] Ignoring key exchange message because relay persistence is activated",k):(F.SocketService(`[SocketService handleMessage()] context=${t.state.context}::on 'message' emit KEY_EXCHANGE`,k),void t.emit(st.KEY_EXCHANGE,{message:k,context:t.state.context}));if(I&&!(null===(l=t.state.keyExchange)||void 0===l?void 0:l.areKeysExchanged())){let n=!1;try{F.SocketService(`[SocketService handleMessage()] context=${t.state.context}::on 'message' trying to decrypt message`),null===(u=t.state.keyExchange)||void 0===u||u.decryptMessage(k),n=!0}catch(e){F.SocketService(`[SocketService handleMessage()] context=${t.state.context}::on 'message' error`,e)}if(!n)return t.state.isOriginator?null===(h=t.state.keyExchange)||void 0===h||h.start({isOriginator:null!==(g=t.state.isOriginator)&&void 0!==g&&g}):t.sendMessage({type:e.KeyExchangeMessageType.KEY_HANDSHAKE_START}).catch((e=>{console.error(`[SocketService handleMessage()] context=${t.state.context}::on 'message' error`,e)})),void F.SocketService(`Message ignored because invalid key exchange status. step=${null===(y=t.state.keyExchange)||void 0===y?void 0:y.getKeyInfo().step}`,null===(m=t.state.keyExchange)||void 0===m?void 0:m.getKeyInfo(),k);F.SocketService("Invalid key exchange status detected --- updating it."),null===(d=t.state.keyExchange)||void 0===d||d.setKeysExchanged(!0)}else if(!I&&(null==k?void 0:k.type))return console.warn("[SocketService handleMessage() ::on 'message' received non encrypted unkwown message"),void t.emit(e.EventType.MESSAGE,k);if(!I)return console.warn("[SocketService handleMessage() ::on 'message' received unkwown message",k),void t.emit(e.EventType.MESSAGE,k);const _=null===(v=t.state.keyExchange)||void 0===v?void 0:v.decryptMessage(k),w=JSON.parse(null!=_?_:"{}");if(T&&(null==T?void 0:T.length)>0&&(F.SocketService(`[SocketService handleMessage()] context=${t.state.context}::on 'message' ackid=${T} channelId=${n}`),null===(f=t.state.socket)||void 0===f||f.emit(e.EventType.MESSAGE_ACK,{ackId:T,channelId:n,clientType:t.state.isOriginator?"dapp":"wallet"})),(null==w?void 0:w.type)===e.MessageType.PAUSE?t.state.clientsPaused=!0:t.state.clientsPaused=!1,t.state.isOriginator&&w.data){const n=w.data,o=t.state.rpcMethodTracker[n.id];if(o){const i=Date.now()-o.timestamp;F.SocketService(`[SocketService handleMessage()] context=${t.state.context}::on 'message' received answer for id=${n.id} method=${o.method} responseTime=${i}`,w),t.remote.state.analytics&&Tt.includes(o.method.toLowerCase())&&G(Object.assign(Object.assign({id:null!==(p=t.remote.state.channelId)&&void 0!==p?p:"",event:e.TrackingEvents.SDK_RPC_REQUEST_DONE,sdkVersion:t.remote.state.sdkVersion,commLayerVersion:Ve.version},t.remote.state.originatorInfo),{walletVersion:null===(E=t.remote.state.walletInfo)||void 0===E?void 0:E.version,params:{method:o.method,from:"mobile"}}),t.remote.state.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)}));const r=Object.assign(Object.assign({},o),{result:n.result,error:n.error?{code:null===(C=n.error)||void 0===C?void 0:C.code,message:null===(S=n.error)||void 0===S?void 0:S.message}:void 0,elapsedTime:i});t.state.rpcMethodTracker[n.id]=r,t.emit(e.EventType.RPC_UPDATE,r)}}t.emit(e.EventType.MESSAGE,{message:w})}}},{event:e.EventType.REJECTED,handler:function(t,n){return o=>r(this,void 0,void 0,(function*(){var o;t.state.isOriginator&&!t.remote.state.ready?(F.SocketService(`[SocketService: handleChannelRejected()] context=${t.state.context} channelId=${n} isOriginator=${t.state.isOriginator} ready=${t.remote.state.ready}`,t.remote.state.originatorInfo),G(Object.assign(Object.assign({id:n,event:e.TrackingEvents.REJECTED},t.remote.state.originatorInfo),{sdkVersion:t.remote.state.sdkVersion,commLayer:t.state.communicationLayerPreference,commLayerVersion:Ve.version,walletVersion:null===(o=t.remote.state.walletInfo)||void 0===o?void 0:o.version}),t.remote.state.communicationServerUrl).catch((e=>{console.error("handleChannelRejected:: Error emitting analytics event",e)})),yield t.remote.disconnect({terminate:!0}),t.remote.emit(e.EventType.REJECTED,{channelId:n}),t.remote.setConnectionStatus(e.ConnectionStatus.DISCONNECTED)):F.SocketService(`[SocketService: handleChannelRejected()] SKIP -- channelId=${n} isOriginator=${t.state.isOriginator} ready=${t.remote.state.ready}`)}))}},{event:"clients_waiting_to_join",handler:function(t,n){return o=>{F.SocketService(`[SocketService: handleClientsWaitingToJoin()] context=${t.state.context} on 'clients_waiting_to_join-${n}'`,o),t.emit(e.EventType.CLIENTS_WAITING,o)}}}],Kt=[{event:e.EventType.KEY_INFO,handler:function(t){return n=>{F.SocketService("[SocketService: handleKeyInfo()] on 'KEY_INFO'",n),t.emit(e.EventType.KEY_INFO,n)}}},{event:e.EventType.KEYS_EXCHANGED,handler:function(t){return()=>{var n,o,i;F.SocketService(`[SocketService: handleKeysExchanged()] on 'keys_exchanged' keyschanged=${null===(n=t.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged()}`);const{channelConfig:r}=t.remote.state;if(r){const e=t.getKeyExchange().getKeyInfo().ecies;r.localKey=e.private,r.otherKey=e.otherPubKey,t.remote.state.channelConfig=r,null===(o=t.remote.state.storageManager)||void 0===o||o.persistChannelConfig(r).catch((e=>{console.error("Error persisting channel config",e)}))}t.emit(e.EventType.KEYS_EXCHANGED,{keysExchanged:null===(i=t.state.keyExchange)||void 0===i?void 0:i.areKeysExchanged(),isOriginator:t.state.isOriginator});const s={keyInfo:t.getKeyInfo()};t.emit(e.EventType.SERVICE_STATUS,s)}}}];function It(t,n){F.SocketService(`[SocketService: setupChannelListener()] context=${t.state.context} setting socket listeners for channel ${n}...`);const{socket:o}=t.state,{keyExchange:i}=t.state;o&&t.state.isOriginator&&(t.state.debug&&(null==o||o.io.on("error",(e=>{F.SocketService(`[SocketService: setupChannelListener()] context=${t.state.context} socket event=error`,e)})),null==o||o.io.on("reconnect",(e=>{F.SocketService(`[SocketService: setupChannelListener()] context=${t.state.context} socket event=reconnect`,e),pt(t).catch((e=>{}))})),null==o||o.io.on("reconnect_error",(e=>{F.SocketService(`[SocketService: setupChannelListener()] context=${t.state.context} socket event=reconnect_error`,e)})),null==o||o.io.on("reconnect_failed",(()=>{F.SocketService(`[SocketService: setupChannelListener()] context=${t.state.context} socket event=reconnect_failed`)}))),null==o||o.on("disconnect",(n=>(F.SocketService(`[SocketService: setupChannelListener()] on 'disconnect' -- MetaMaskSDK socket disconnected '${n}' begin recovery...`),function(t){return n=>{F.SocketService(`[SocketService: handleDisconnect()] on 'disconnect' manualDisconnect=${t.state.manualDisconnect}`,n),t.state.manualDisconnect||(t.emit(e.EventType.SOCKET_DISCONNECTED),pt(t).catch((e=>{console.error("SocketService::handleDisconnect Error reconnecting socket",e)})))}}(t)(n))))),xt.forEach((({event:e,handler:i})=>{const r=`${e}-${n}`;null==o||o.on(r,i(t,n))})),Kt.forEach((({event:e,handler:n})=>{null==i||i.on(e,n(t))})),t.state.setupChannelListeners=!0}class _t extends o.EventEmitter2{constructor(e){super(),this.state={clientsConnected:!1,clientsPaused:!1,manualDisconnect:!1,lastRpcId:void 0,rpcMethodTracker:{},hasPlaintext:!1,communicationServerUrl:"",focusListenerAdded:!1,removeFocusListener:void 0,isReconnecting:!1,reconnectionAttempts:0},this.options=e;const{reconnect:t,communicationLayerPreference:n,communicationServerUrl:o,context:i,remote:r,logging:s}=e;this.state.resumed=t,this.state.context=i,this.state.isOriginator=r.state.isOriginator,this.state.communicationLayerPreference=n,this.state.debug=!0===(null==s?void 0:s.serviceLayer),this.remote=r,!0===(null==s?void 0:s.serviceLayer)&&L.enable("SocketService:Layer"),this.state.communicationServerUrl=o,this.state.hasPlaintext=this.state.communicationServerUrl!==Ge&&!0===(null==s?void 0:s.plaintext),F.SocketService(`[SocketService: constructor()] Socket IO url: ${this.state.communicationServerUrl}`),this.initSocket()}initSocket(){var e;const{otherPublicKey:t,ecies:n,logging:o}=this.options,r={autoConnect:!1,transports:We,withCredentials:!0},s=this.state.communicationServerUrl;F.SocketService(`[SocketService: initSocket()] Socket IO url: ${s}`),this.state.socket=i.io(s,r),function(e){if("undefined"!=typeof window&&"undefined"!=typeof document&&(F.SocketService(`[SocketService: setupSocketFocusListener()] hasFocus=${document.hasFocus()}`,e),!e.state.focusListenerAdded)){const t=()=>{F.SocketService("Document has focus --- reconnecting socket"),pt(e).catch((e=>{console.error("setupSocketFocusListeners Error reconnecting socket",e)}))};window.addEventListener("focus",t),e.state.focusListenerAdded=!0,e.state.removeFocusListener=()=>{window.removeEventListener("focus",t),e.state.focusListenerAdded=!1}}}(this);const a={communicationLayer:this,otherPublicKey:t,sendPublicKey:!1,context:null!==(e=this.state.context)&&void 0!==e?e:"",ecies:n,logging:o};this.state.keyExchange=new gt(a)}resetKeys(){return e=this,F.SocketService("[SocketService: resetKeys()] Resetting keys."),void(null===(t=e.state.keyExchange)||void 0===t||t.resetKeys());var e,t}createChannel(){return r(this,void 0,void 0,(function*(){return function(t){var n,o,i;return r(this,void 0,void 0,(function*(){if(F.SocketService(`[SocketService: createChannel()] context=${t.state.context}`),t.state.socket||t.initSocket(),null===(n=t.state.socket)||void 0===n?void 0:n.connected)throw console.error("[SocketService: createChannel()] socket already connected"),new Error("socket already connected");null===(o=t.state.socket)||void 0===o||o.connect(),t.state.manualDisconnect=!1,t.state.isOriginator=!0;const s=ht();t.state.channelId=s,It(t,s),yield new Promise(((n,o)=>{var i;null===(i=t.state.socket)||void 0===i||i.emit(e.EventType.JOIN_CHANNEL,{channelId:s,context:`${t.state.context}createChannel`,clientType:"dapp"},((e,i)=>r(this,void 0,void 0,(function*(){try{yield yt(t,e,i),n()}catch(e){o(e)}}))))}));const a=null===(i=t.state.keyExchange)||void 0===i?void 0:i.getKeyInfo();return{channelId:s,pubKey:(null==a?void 0:a.ecies.public)||"",privKey:(null==a?void 0:a.ecies.private)||""}}))}(this)}))}connectToChannel({channelId:t,withKeyExchange:n=!1,authorized:o}){return function({options:t,instance:n}){return r(this,void 0,void 0,(function*(){const{channelId:o,authorized:i,withKeyExchange:s}=t,{state:a,remote:c}=n,{isOriginator:l=!1,socket:u,keyExchange:d}=a,{channelConfig:h}=c.state;if(null==u?void 0:u.connected)throw console.error("[SocketService: connectToChannel()] socket already connected"),new Error("socket already connected");if(l&&(null==h?void 0:h.relayPersistence)){const{localKey:e,otherKey:t}=h;e&&t?null==d||d.setRelayPersistence({localKey:e,otherKey:t}):console.warn("Missing keys in relay persistence",h)}return Object.assign(a,{manualDisconnect:!1,withKeyExchange:s,isOriginator:l,channelId:o}),null==u||u.connect(),It(n,o),!l&&i&&(null==d||d.setKeysExchanged(!0),Object.assign(c.state,{ready:!0,authorized:!0})),new Promise((t=>{var s;const c=null===(s=null==d?void 0:d.getKeyInfo())||void 0===s?void 0:s.ecies.public,h=i&&!l?c:void 0;null==u||u.emit(e.EventType.JOIN_CHANNEL,{channelId:o,context:`${a.context}_connectToChannel`,clientType:l?"dapp":"wallet",publicKey:h},((e,o)=>r(this,void 0,void 0,(function*(){yield yt(n,e,o),t()}))))}))}))}({options:{channelId:t,withKeyExchange:n,authorized:o},instance:this})}getKeyInfo(){return this.state.keyExchange.getKeyInfo()}keyCheck(){var t,n;null===(n=(t=this).state.socket)||void 0===n||n.emit(e.EventType.MESSAGE,{id:t.state.channelId,context:t.state.context,message:{type:e.KeyExchangeMessageType.KEY_HANDSHAKE_CHECK,pubkey:t.getKeyInfo().ecies.otherPubKey}})}getKeyExchange(){return this.state.keyExchange}sendMessage(e){return r(this,void 0,void 0,(function*(){return kt(this,e)}))}ping(){return function(t){var n,o;return r(this,void 0,void 0,(function*(){F.SocketService(`[SocketService: ping()] context=${t.state.context} originator=${t.state.isOriginator} keysExchanged=${null===(n=t.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged()}`),null===(o=t.state.socket)||void 0===o||o.emit(e.MessageType.PING,{id:t.state.channelId,context:"ping",clientType:t.remote.state.isOriginator?"dapp":"wallet",message:""})}))}(this)}pause(){return function(t){var n,o;return r(this,void 0,void 0,(function*(){F.SocketService(`[SocketService: pause()] context=${t.state.context}`),t.state.manualDisconnect=!0,(null===(n=t.state.keyExchange)||void 0===n?void 0:n.areKeysExchanged())&&(yield t.sendMessage({type:e.MessageType.PAUSE})),null===(o=t.state.socket)||void 0===o||o.disconnect()}))}(this)}isConnected(){var e;return null===(e=this.state.socket)||void 0===e?void 0:e.connected}resume(){return function(t){return r(this,void 0,void 0,(function*(){const{state:n,remote:o}=t,{socket:i,channelId:s,context:a,keyExchange:c,isOriginator:l}=n,{isOriginator:u}=o.state;if(F.SocketService(`[SocketService: resume()] channelId=${s} context=${a} connected=${null==i?void 0:i.connected} manualDisconnect=${n.manualDisconnect} resumed=${n.resumed} keysExchanged=${null==c?void 0:c.areKeysExchanged()}`),!s)throw F.SocketService("[SocketService: resume()] channelId is not defined"),new Error("ChannelId is not defined");(null==i?void 0:i.connected)?(F.SocketService("[SocketService: resume()] already connected."),i.emit(e.MessageType.PING,{id:s,clientType:u?"dapp":"wallet",context:"on_channel_config",message:""}),o.hasRelayPersistence()||(null==c?void 0:c.areKeysExchanged())||(l?yield t.sendMessage({type:e.MessageType.READY}):null==c||c.start({isOriginator:!1}))):(null==i||i.connect(),F.SocketService(`[SocketService: resume()] after connecting socket --\x3e connected=${null==i?void 0:i.connected}`),null==i||i.emit(e.EventType.JOIN_CHANNEL,{channelId:s,context:`${a}_resume`,clientType:u?"dapp":"wallet"},((e,n)=>r(this,void 0,void 0,(function*(){try{yield yt(t,e,n)}catch(e){console.warn("Error reconnecting to channel",e)}}))))),n.manualDisconnect=!1,n.resumed=!0}))}(this)}getRPCMethodTracker(){return this.state.rpcMethodTracker}disconnect(e){return function(e,t){var n,o,i,r,s;F.SocketService(`[SocketService: disconnect()] context=${e.state.context}`,t),(null==t?void 0:t.terminate)&&(null===(o=(n=e.state).removeFocusListener)||void 0===o||o.call(n),e.state.channelId=t.channelId,null===(i=e.state.socket)||void 0===i||i.removeAllListeners(),null===(r=e.state.keyExchange)||void 0===r||r.clean(),e.remote.state.ready=!1,e.state.socket=void 0,e.state.rpcMethodTracker={}),e.state.manualDisconnect=!0,null===(s=e.state.socket)||void 0===s||s.disconnect()}(this,e)}}var wt,At;function Rt(t){return()=>r(this,void 0,void 0,(function*(){var n,o,i;const{state:s}=t;if(s.authorized)return;yield(()=>r(this,void 0,void 0,(function*(){for(;!s.walletInfo;)yield mt(500)})))();const a="7.3".localeCompare((null===(n=s.walletInfo)||void 0===n?void 0:n.version)||"");if(F.RemoteCommunication(`[RemoteCommunication: handleAuthorizedEvent()] HACK 'authorized' version=${null===(o=s.walletInfo)||void 0===o?void 0:o.version} compareValue=${a}`),1!==a)return;const c=s.platformType===e.PlatformType.MobileWeb||s.platformType===e.PlatformType.ReactNative||s.platformType===e.PlatformType.MetaMaskMobileWebview;F.RemoteCommunication(`[RemoteCommunication: handleAuthorizedEvent()] HACK 'authorized' platform=${s.platformType} secure=${c} channel=${s.channelId} walletVersion=${null===(i=s.walletInfo)||void 0===i?void 0:i.version}`),c&&(s.authorized=!0,t.emit(e.EventType.AUTHORIZED))}))}function bt(t){return n=>{const{state:o}=t;F.RemoteCommunication(`[RemoteCommunication: handleChannelCreatedEvent()] context=${o.context} on 'channel_created' channelId=${n}`),t.emit(e.EventType.CHANNEL_CREATED,n)}}function Nt(t,n){return()=>{var o,i,r,s;const{state:a}=t;if(F.RemoteCommunication(`[RemoteCommunication: handleClientsConnectedEvent()] on 'clients_connected' channel=${a.channelId} keysExchanged=${null===(i=null===(o=a.communicationLayer)||void 0===o?void 0:o.getKeyInfo())||void 0===i?void 0:i.keysExchanged}`),a.analytics){const t=a.isOriginator?e.TrackingEvents.REQUEST:e.TrackingEvents.REQUEST_MOBILE;G(Object.assign(Object.assign({id:null!==(r=a.channelId)&&void 0!==r?r:"",event:a.reconnection?e.TrackingEvents.RECONNECT:t},a.originatorInfo),{commLayer:n,sdkVersion:a.sdkVersion,walletVersion:null===(s=a.walletInfo)||void 0===s?void 0:s.version,commLayerVersion:Ve.version}),a.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)}))}a.clientsConnected=!0,a.originatorInfoSent=!1,t.emit(e.EventType.CLIENTS_CONNECTED)}}function Ot(t){return n=>{const{state:o}=t;F.RemoteCommunication(`[RemoteCommunication: handleClientsDisconnectedEvent()] context=${o.context} on 'clients_disconnected' channelId=${n}`),o.relayPersistence||(o.clientsConnected=!1,o.ready=!1,o.authorized=!1),t.emit(e.EventType.CLIENTS_DISCONNECTED,o.channelId),t.setConnectionStatus(e.ConnectionStatus.DISCONNECTED)}}function Pt(t){return n=>{var o;const{state:i}=t;if(F.RemoteCommunication(`[RemoteCommunication: handleClientsWaitingEvent()] context=${i.context} on 'clients_waiting' numberUsers=${n} ready=${i.ready} autoStarted=${i.originatorConnectStarted}`),t.setConnectionStatus(e.ConnectionStatus.WAITING),t.emit(e.EventType.CLIENTS_WAITING,n),i.originatorConnectStarted){F.RemoteCommunication(`[RemoteCommunication: handleClientsWaitingEvent()] on 'clients_waiting' watch autoStarted=${i.originatorConnectStarted} timeout`,i.autoConnectOptions);const n=(null===(o=i.autoConnectOptions)||void 0===o?void 0:o.timeout)||3e3,r=setTimeout((()=>{F.RemoteCommunication(`[RemoteCommunication: handleClientsWaitingEvent()] setTimeout(${n}) terminate channelConfig`,i.autoConnectOptions),i.originatorConnectStarted=!1,i.ready||t.setConnectionStatus(e.ConnectionStatus.TIMEOUT),clearTimeout(r)}),n)}}}function Mt(t,n){return o=>{var i,r,s,a,c,l,u,d;const{state:h}=t;if(F.RemoteCommunication(`[RemoteCommunication: handleKeysExchangedEvent()] context=${h.context} on commLayer.'keys_exchanged' channel=${h.channelId}`,o),null===(r=null===(i=h.communicationLayer)||void 0===i?void 0:i.getKeyInfo())||void 0===r?void 0:r.keysExchanged){const n=Object.assign(Object.assign({},h.channelConfig),{channelId:null!==(s=h.channelId)&&void 0!==s?s:"",validUntil:(null===(a=h.channelConfig)||void 0===a?void 0:a.validUntil)||Je,localKey:h.communicationLayer.getKeyInfo().ecies.private,otherKey:h.communicationLayer.getKeyInfo().ecies.otherPubKey});null===(c=h.storageManager)||void 0===c||c.persistChannelConfig(n).catch((e=>{console.error("Error persisting channel config",e)})),t.setConnectionStatus(e.ConnectionStatus.LINKED)}!function(e,t){var n,o,i,r,s,a,c,l;const{state:u}=e;F.RemoteCommunication(`[RemoteCommunication: setLastActiveDate()] channel=${u.channelId}`,t);const d=Object.assign(Object.assign({},u.channelConfig),{channelId:null!==(n=u.channelId)&&void 0!==n?n:"",validUntil:null!==(i=null===(o=u.channelConfig)||void 0===o?void 0:o.validUntil)&&void 0!==i?i:0,relayPersistence:u.relayPersistence,localKey:null===(s=null===(r=u.communicationLayer)||void 0===r?void 0:r.state.keyExchange)||void 0===s?void 0:s.getKeyInfo().ecies.private,otherKey:null===(c=null===(a=u.communicationLayer)||void 0===a?void 0:a.state.keyExchange)||void 0===c?void 0:c.getKeyInfo().ecies.otherPubKey,lastActive:t.getTime()});null===(l=u.storageManager)||void 0===l||l.persistChannelConfig(d)}(t,new Date),h.analytics&&h.channelId&&G(Object.assign(Object.assign({id:h.channelId,event:o.isOriginator?e.TrackingEvents.CONNECTED:e.TrackingEvents.CONNECTED_MOBILE},h.originatorInfo),{sdkVersion:h.sdkVersion,commLayer:n,commLayerVersion:Ve.version,walletVersion:null===(l=h.walletInfo)||void 0===l?void 0:l.version}),h.communicationServerUrl).catch((e=>{console.error("Cannot send analytics",e)})),h.isOriginator=o.isOriginator,o.isOriginator||(null===(u=h.communicationLayer)||void 0===u||u.sendMessage({type:e.MessageType.READY}),h.ready=!0,h.paused=!1),o.isOriginator&&!h.originatorInfoSent&&(null===(d=h.communicationLayer)||void 0===d||d.sendMessage({type:e.MessageType.ORIGINATOR_INFO,originatorInfo:h.originatorInfo,originator:h.originatorInfo}),h.originatorInfoSent=!0)}}function Dt(t,n){const{state:o}=n;if(F.RemoteCommunication(`[RemoteCommunication: onCommunicationLayerMessage()] context=${o.context} on 'message' typeof=${typeof t}`,t),n.state.ready=!0,o.isOriginator||t.type!==e.MessageType.ORIGINATOR_INFO)if(o.isOriginator&&t.type===e.MessageType.WALLET_INFO)!function(e,t){const{state:n}=e;n.walletInfo=t.walletInfo,n.paused=!1}(n,t);else{if(o.isOriginator&&t.type===e.MessageType.WALLET_INIT)(function(t,n){var o,i,s;return r(this,void 0,void 0,(function*(){const{state:r}=t;if(r.isOriginator){const r=n.data||{};if("object"==typeof r&&"accounts"in r&&"chainId"in r&&"walletKey"in r)try{const{channelConfig:n}=t.state;if(F.RemoteCommunication("WALLET_INIT: channelConfig",JSON.stringify(n,null,2)),n){const e=r.accounts,a=r.chainId,c=r.walletKey;let l,u=!1;"deeplinkProtocol"in r&&(u=Boolean(r.deeplinkProtocol),t.state.deeplinkProtocolAvailable=u),"walletVersion"in r&&(l=r.walletVersion),yield null===(o=t.state.storageManager)||void 0===o?void 0:o.persistChannelConfig(Object.assign(Object.assign({},n),{otherKey:c,walletVersion:l,deeplinkProtocolAvailable:u,relayPersistence:!0})),yield null===(i=t.state.storageManager)||void 0===i?void 0:i.persistAccounts(e),yield null===(s=t.state.storageManager)||void 0===s?void 0:s.persistChainId(a)}t.emit(e.EventType.WALLET_INIT,{accounts:r.accounts,chainId:r.chainId})}catch(e){console.error('RemoteCommunication::on "wallet_init" -- error',e)}else console.error('RemoteCommunication::on "wallet_init" -- invalid data format',r)}}))})(n,t).catch((e=>{F.RemoteCommunication(`[RemoteCommunication: onCommunicationLayerMessage()] error=${e}`)}));else if(t.type===e.MessageType.TERMINATE)(function(t){return r(this,void 0,void 0,(function*(){const{state:n}=t;n.isOriginator&&(yield jt({options:{terminate:!0,sendMessage:!1},instance:t}),t.emit(e.EventType.TERMINATE))}))})(n).catch((e=>{F.RemoteCommunication(`[RemoteCommunication: onCommunicationLayerMessage()] error=${e}`)}));else if(t.type===e.MessageType.PAUSE)!function(t){const{state:n}=t;n.paused=!0,t.setConnectionStatus(e.ConnectionStatus.PAUSED)}(n);else if(t.type===e.MessageType.READY&&o.isOriginator)!function(t){const{state:n}=t;t.setConnectionStatus(e.ConnectionStatus.LINKED);const o=n.paused;n.paused=!1,t.emit(e.EventType.CLIENTS_READY,{isOriginator:n.isOriginator,walletInfo:n.walletInfo}),o&&(n.authorized=!0,t.emit(e.EventType.AUTHORIZED))}(n);else{if(t.type===e.MessageType.OTP&&o.isOriginator)return void function(t,n){var o;const{state:i}=t;t.emit(e.EventType.OTP,n.otpAnswer),1==="6.6".localeCompare((null===(o=i.walletInfo)||void 0===o?void 0:o.version)||"")&&(console.warn("RemoteCommunication::on 'otp' -- backward compatibility <6.6 -- triger eth_requestAccounts"),t.emit(e.EventType.SDK_RPC_CALL,{method:qe.ETH_REQUESTACCOUNTS,params:[]}))}(n,t);t.type===e.MessageType.AUTHORIZED&&o.isOriginator&&function(t){const{state:n}=t;n.authorized=!0,t.emit(e.EventType.AUTHORIZED)}(n)}n.emit(e.EventType.MESSAGE,t)}else!function(t,n){var o;const{state:i}=t;null===(o=i.communicationLayer)||void 0===o||o.sendMessage({type:e.MessageType.WALLET_INFO,walletInfo:i.walletInfo}),i.originatorInfo=n.originatorInfo||n.originator,t.emit(e.EventType.CLIENTS_READY,{isOriginator:i.isOriginator,originatorInfo:i.originatorInfo}),i.paused=!1}(n,t)}function Lt(t,n){var o,i;return r(this,void 0,void 0,(function*(){const{state:s}=t;F.RemoteCommunication(`[RemoteCommunication: sendMessage()] context=${s.context} paused=${s.paused} ready=${s.ready} relayPersistence=${s.relayPersistence} authorized=${s.authorized} socket=${null===(o=s.communicationLayer)||void 0===o?void 0:o.isConnected()} clientsConnected=${s.clientsConnected} status=${s._connectionStatus}`,n),s.relayPersistence||s.ready&&(null===(i=s.communicationLayer)||void 0===i?void 0:i.isConnected())&&s.clientsConnected||(F.RemoteCommunication(`[RemoteCommunication: sendMessage()] context=${s.context}  SKIP message waiting for MM mobile readiness.`),yield new Promise((n=>{t.once(e.EventType.CLIENTS_READY,n)})),F.RemoteCommunication(`[RemoteCommunication: sendMessage()] context=${s.context}  AFTER SKIP / READY -- sending pending message`));try{const o=yield function(t,n){return r(this,void 0,void 0,(function*(){return new Promise((o=>{var i;const{state:r}=t;F.RemoteCommunication(`[RemoteCommunication: handleAuthorization()] context=${r.context} ready=${r.ready} authorized=${r.authorized} method=${n.method}`),!r.isOriginator||r.authorized||r.relayPersistence?null===(i=r.communicationLayer)||void 0===i||i.sendMessage(n).then((e=>{o(e)})).catch((e=>{console.error(`[RemoteCommunication: handleAuthorization()] context=${r.context}  ERROR`,e),o(!1)})):t.once(e.EventType.AUTHORIZED,(()=>{var e;F.RemoteCommunication(`[RemoteCommunication: handleAuthorization()] context=${r.context}  AFTER SKIP / AUTHORIZED -- sending pending message`),null===(e=r.communicationLayer)||void 0===e||e.sendMessage(n).then((e=>{o(e)})).catch((e=>{console.error(`[RemoteCommunication: handleAuthorization()] context=${r.context}  ERROR`,e),o(!1)}))}))}))}))}(t,n);return o}catch(e){throw console.error(`[RemoteCommunication: sendMessage()] context=${s.context}  ERROR`,e),e}}))}function $t(e){return t=>{let n=t;t.message&&(n=n.message),Dt(n,e)}}function Ht(e){return()=>{const{state:t}=e;F.RemoteCommunication("[RemoteCommunication: handleSocketReconnectEvent()] on 'socket_reconnect' -- reset key exchange status / set ready to false"),t.ready=!1,t.authorized=!1,Xe(t),e.emitServiceStatusEvent({context:"socket_reconnect"})}}function Ut(e){return()=>{const{state:t}=e;F.RemoteCommunication("[RemoteCommunication: handleSocketDisconnectedEvent()] on 'socket_Disconnected' set ready to false"),t.ready=!1}}function Yt(t){return()=>r(this,void 0,void 0,(function*(){var n,o,i,r,s,a,c;const{state:l}=t;F.RemoteCommunication(`[RemoteCommunication: handleFullPersistenceEvent()] context=${l.context}`),t.state.ready=!0,t.state.clientsConnected=!0,t.state.authorized=!0,t.state.relayPersistence=!0,null===(n=t.state.communicationLayer)||void 0===n||n.getKeyExchange().setKeysExchanged(!0),t.emit(e.EventType.KEYS_EXCHANGED,{keysExchanged:!0,isOriginator:!0}),t.emit(e.EventType.AUTHORIZED),t.emit(e.EventType.CLIENTS_READY),t.emit(e.EventType.CHANNEL_PERSISTENCE);try{l.channelConfig=Object.assign(Object.assign({},l.channelConfig),{localKey:null===(o=l.communicationLayer)||void 0===o?void 0:o.getKeyExchange().getKeyInfo().ecies.private,otherKey:null===(i=l.communicationLayer)||void 0===i?void 0:i.getKeyExchange().getOtherPublicKey(),channelId:null!==(r=l.channelId)&&void 0!==r?r:"",validUntil:null!==(a=null===(s=l.channelConfig)||void 0===s?void 0:s.validUntil)&&void 0!==a?a:Je,relayPersistence:!0}),yield null===(c=l.storageManager)||void 0===c?void 0:c.persistChannelConfig(l.channelConfig)}catch(e){console.error("Error persisting channel config",e)}}))}function Ft({communicationLayerPreference:t,otherPublicKey:n,reconnect:o,ecies:i,communicationServerUrl:r=Ge,instance:s}){var a,c,l,u,d,h,g,y,m,v,f;const{state:p}=s;if(F.RemoteCommunication("[initCommunicationLayer()] ",JSON.stringify(p,null,2)),t!==e.CommunicationLayerPreference.SOCKET)throw new Error("Invalid communication protocol");p.communicationLayer=new _t({communicationLayerPreference:t,otherPublicKey:n,reconnect:o,transports:p.transports,communicationServerUrl:r,context:p.context,ecies:i,logging:p.logging,remote:s});let E="undefined"!=typeof document&&document.URL||"",C="undefined"!=typeof document&&document.title||"";(null===(a=p.dappMetadata)||void 0===a?void 0:a.url)&&(E=p.dappMetadata.url),(null===(c=p.dappMetadata)||void 0===c?void 0:c.name)&&(C=p.dappMetadata.name);const S=null!==(h=null!==(u=null===(l=p.dappMetadata)||void 0===l?void 0:l.name)&&void 0!==u?u:null===(d=p.dappMetadata)||void 0===d?void 0:d.url)&&void 0!==h?h:"N/A",T="undefined"!=typeof window&&void 0!==window.location&&null!==(g=window.location.hostname)&&void 0!==g?g:S,k={url:E,title:C,source:null===(y=p.dappMetadata)||void 0===y?void 0:y.source,dappId:T,icon:(null===(m=p.dappMetadata)||void 0===m?void 0:m.iconUrl)||(null===(v=p.dappMetadata)||void 0===v?void 0:v.base64Icon),platform:p.platformType,apiVersion:Ve.version,connector:null===(f=p.dappMetadata)||void 0===f?void 0:f.connector};p.originatorInfo=k;const x={[e.EventType.AUTHORIZED]:Rt(s),[e.EventType.MESSAGE]:$t(s),[e.EventType.CHANNEL_PERSISTENCE]:Yt(s),[e.EventType.CLIENTS_CONNECTED]:Nt(s,t),[e.EventType.KEYS_EXCHANGED]:Mt(s,t),[e.EventType.SOCKET_DISCONNECTED]:Ut(s),[e.EventType.SOCKET_RECONNECT]:Ht(s),[e.EventType.CLIENTS_DISCONNECTED]:Ot(s),[e.EventType.KEY_INFO]:()=>{},[e.EventType.CHANNEL_CREATED]:bt(s),[e.EventType.CLIENTS_WAITING]:Pt(s),[e.EventType.RPC_UPDATE]:t=>{s.emit(e.EventType.RPC_UPDATE,t)}};for(const[e,t]of Object.entries(x))try{p.communicationLayer.on(e,t)}catch(t){console.error(`Error registering handler for ${e}:`,t)}}function jt({options:t,instance:n}){return r(this,void 0,void 0,(function*(){const{state:o}=n;return F.RemoteCommunication(`[RemoteCommunication: disconnect()] channel=${o.channelId}`,t),new Promise(((i,r)=>{var s,a,c,l,u,d;(null==t?void 0:t.terminate)?(n.state.ready&&G({id:null!==(s=n.state.channelId)&&void 0!==s?s:"",event:e.TrackingEvents.TERMINATED},n.state.communicationServerUrl).catch((e=>{console.error("[handleSendMessage] Cannot send analytics",e)})),o.ready=!1,o.paused=!1,null===(a=o.storageManager)||void 0===a||a.terminate(null!==(c=o.channelId)&&void 0!==c?c:""),n.state.terminated=!0,t.sendMessage?(null===(l=o.communicationLayer)||void 0===l?void 0:l.getKeyInfo().keysExchanged)&&n.state.communicationLayer&&Et(n.state.communicationLayer,{type:e.MessageType.TERMINATE}).then((()=>{console.warn("[disconnect] Terminate message sent to the other peer"),i(!0)})).catch((e=>{r(e)})):i(!0),o.authorized=!1,o.relayPersistence=!1,o.channelId=ht(),t.channelId=o.channelId,o.channelConfig=void 0,o.originatorConnectStarted=!1,null===(u=o.communicationLayer)||void 0===u||u.disconnect(t),n.setConnectionStatus(e.ConnectionStatus.TERMINATED)):(null===(d=o.communicationLayer)||void 0===d||d.disconnect(t),n.setConnectionStatus(e.ConnectionStatus.DISCONNECTED),i(!0))}))}))}e.CommunicationLayerPreference=void 0,(e.CommunicationLayerPreference||(e.CommunicationLayerPreference={})).SOCKET="socket",e.PlatformType=void 0,(wt=e.PlatformType||(e.PlatformType={})).NonBrowser="nodejs",wt.MetaMaskMobileWebview="in-app-browser",wt.DesktopWeb="web-desktop",wt.MobileWeb="web-mobile",wt.ReactNative="react-native";class zt extends o.EventEmitter2{constructor(t){super(),this.state={ready:!1,authorized:!1,isOriginator:!1,terminated:!1,protocolVersion:1,paused:!1,deeplinkProtocolAvailable:!1,platformType:"metamask-mobile",analytics:!1,reconnection:!1,originatorInfoSent:!1,communicationServerUrl:Ge,context:"",persist:!1,clientsConnected:!1,sessionDuration:Je,originatorConnectStarted:!1,debug:!1,_connectionStatus:e.ConnectionStatus.DISCONNECTED},this._options=t;const{platformType:n,communicationLayerPreference:o,otherPublicKey:i,reconnect:r,walletInfo:s,dappMetadata:a,protocolVersion:c,transports:l,context:u,relayPersistence:d,ecies:h,analytics:g=!1,storage:y,sdkVersion:m,communicationServerUrl:v=Ge,logging:f,autoConnect:p={timeout:Ze}}=t;this.state.otherPublicKey=i,this.state.dappMetadata=a,this.state.walletInfo=s,this.state.transports=l,this.state.platformType=n,this.state.analytics=g,this.state.protocolVersion=null!=c?c:1,this.state.isOriginator=!i,this.state.relayPersistence=d,this.state.communicationServerUrl=v,this.state.context=u,this.state.terminated=!1,this.state.sdkVersion=m,this.setMaxListeners(50),this.setConnectionStatus(e.ConnectionStatus.DISCONNECTED),(null==y?void 0:y.duration)&&(this.state.sessionDuration=Je),this.state.storageOptions=y,this.state.autoConnectOptions=p,this.state.debug=!0===(null==f?void 0:f.remoteLayer),!0===(null==f?void 0:f.remoteLayer)&&L.enable("RemoteCommunication:Layer"),!0===(null==f?void 0:f.serviceLayer)&&L.enable("SocketService:Layer"),!0===(null==f?void 0:f.eciesLayer)&&L.enable("ECIES:Layer"),!0===(null==f?void 0:f.keyExchangeLayer)&&L.enable("KeyExchange:Layer"),this.state.logging=f,(null==y?void 0:y.storageManager)&&(this.state.storageManager=y.storageManager),F.RemoteCommunication(`[RemoteCommunication: constructor()] protocolVersion=${c} relayPersistence=${d} isOriginator=${this.state.isOriginator} communicationLayerPreference=${o} otherPublicKey=${i} reconnect=${r}`),this.state.isOriginator||Ft({communicationLayerPreference:o,otherPublicKey:i,reconnect:r,ecies:h,communicationServerUrl:v,instance:this}),this.emitServiceStatusEvent({context:"constructor"})}initFromDappStorage(){var t;return r(this,void 0,void 0,(function*(){if(this.state.storageManager){const n=yield this.state.storageManager.getPersistedChannelConfig({});n&&(this.state.channelConfig=n,this.state.channelId=n.channelId,this.state.deeplinkProtocolAvailable=null!==(t=n.deeplinkProtocolAvailable)&&void 0!==t&&t,n.relayPersistence&&(this.state.authorized=!0,this.state.ready=!0,this.setConnectionStatus(e.ConnectionStatus.LINKED),yield this.connectToChannel({channelId:n.channelId})))}Ft({communicationLayerPreference:e.CommunicationLayerPreference.SOCKET,otherPublicKey:this.state.otherPublicKey,reconnect:this._options.reconnect,ecies:this._options.ecies,communicationServerUrl:this.state.communicationServerUrl,instance:this})}))}originatorSessionConnect(){return r(this,void 0,void 0,(function*(){return yield function(e){var t;return r(this,void 0,void 0,(function*(){const{state:n}=e;if(!n.storageManager)return void F.RemoteCommunication("[RemoteCommunication: originatorSessionConnect()] no storage manager defined - skip");const o=yield n.storageManager.getPersistedChannelConfig({});if(F.RemoteCommunication(`[RemoteCommunication: originatorSessionConnect()] autoStarted=${n.originatorConnectStarted} channelConfig`,o),null===(t=n.communicationLayer)||void 0===t?void 0:t.isConnected())return F.RemoteCommunication("[RemoteCommunication: originatorSessionConnect()] socket already connected - skip"),o;if(o){if(o.validUntil>Date.now())return n.channelConfig=o,n.originatorConnectStarted=!0,n.channelId=null==o?void 0:o.channelId,n.reconnection=!0,o;F.RemoteCommunication("[RemoteCommunication: autoConnect()] Session has expired")}n.originatorConnectStarted=!1}))}(this)}))}generateChannelIdConnect(){return r(this,void 0,void 0,(function*(){return function(e){var t,n,o,i,s,a;return r(this,void 0,void 0,(function*(){if(!e.communicationLayer)throw new Error("communication layer not initialized");if(e.ready)throw new Error("Channel already connected");if(e.channelId&&(null===(t=e.communicationLayer)||void 0===t?void 0:t.isConnected()))return e.channelConfig=Object.assign(Object.assign({},e.channelConfig),{channelId:e.channelId,validUntil:Date.now()+e.sessionDuration}),null===(n=e.storageManager)||void 0===n||n.persistChannelConfig(e.channelConfig),{channelId:e.channelId,privKey:null===(i=null===(o=e.communicationLayer)||void 0===o?void 0:o.getKeyInfo())||void 0===i?void 0:i.ecies.private,pubKey:null===(a=null===(s=e.communicationLayer)||void 0===s?void 0:s.getKeyInfo())||void 0===a?void 0:a.ecies.public};F.RemoteCommunication("[RemoteCommunication: generateChannelId()]");const r=yield e.communicationLayer.createChannel();F.RemoteCommunication("[RemoteCommunication: generateChannelId()] channel created",r);const c=Object.assign(Object.assign({},e.channelConfig),{channelId:r.channelId,localKey:r.privKey,validUntil:Date.now()+e.sessionDuration});return e.channelId=r.channelId,e.channelConfig=c,{channelId:e.channelId,pubKey:r.pubKey,privKey:r.privKey}}))}(this.state)}))}clean(){return Xe(this.state)}connectToChannel({channelId:e,withKeyExchange:t,authorized:n}){return function({channelId:e,withKeyExchange:t,authorized:n,state:o}){var i,s,a;return r(this,void 0,void 0,(function*(){if(!ot(e))throw F.RemoteCommunication(`[RemoteCommunication: connectToChannel()] context=${o.context} invalid channel channelId=${e}`),new Error(`Invalid channel ${e}`);if(F.RemoteCommunication(`[RemoteCommunication: connectToChannel()] context=${o.context} channelId=${e} withKeyExchange=${t}`),null===(i=o.communicationLayer)||void 0===i?void 0:i.isConnected())return void F.RemoteCommunication(`[RemoteCommunication: connectToChannel()] context=${o.context} already connected - interrupt connection.`);o.channelId=e,yield null===(s=o.communicationLayer)||void 0===s?void 0:s.connectToChannel({channelId:e,authorized:n,withKeyExchange:t});const r=Object.assign(Object.assign({},o.channelConfig),{channelId:e,validUntil:Date.now()+o.sessionDuration});o.channelConfig=r,null===(a=o.storageManager)||void 0===a||a.persistChannelConfig(r)}))}({channelId:e,authorized:n,withKeyExchange:t,state:this.state})}sendMessage(e){return Lt(this,e)}testStorage(){return r(this,void 0,void 0,(function*(){return function(e){var t;return r(this,void 0,void 0,(function*(){const n=yield null===(t=e.storageManager)||void 0===t?void 0:t.getPersistedChannelConfig();F.RemoteCommunication("[RemoteCommunication: testStorage()] res",n)}))}(this.state)}))}hasDeeplinkProtocol(){return this.state.deeplinkProtocolAvailable}getChannelConfig(){return this.state.channelConfig}isReady(){return this.state.ready}isConnected(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.isConnected()}isAuthorized(){return this.state.authorized}isPaused(){return this.state.paused}getCommunicationLayer(){return this.state.communicationLayer}ping(){var e;return r(this,void 0,void 0,(function*(){F.RemoteCommunication(`[RemoteCommunication: ping()] channel=${this.state.channelId}`),yield null===(e=this.state.communicationLayer)||void 0===e?void 0:e.ping()}))}testLogger(){F.RemoteCommunication(`testLogger() channel=${this.state.channelId}`),F.SocketService(`testLogger() channel=${this.state.channelId}`),F.Ecies(`testLogger() channel=${this.state.channelId}`),F.KeyExchange(`testLogger() channel=${this.state.channelId}`)}keyCheck(){var e;F.RemoteCommunication(`[RemoteCommunication: keyCheck()] channel=${this.state.channelId}`),null===(e=this.state.communicationLayer)||void 0===e||e.keyCheck()}setConnectionStatus(t){this.state._connectionStatus!==t&&(this.state._connectionStatus=t,this.emit(e.EventType.CONNECTION_STATUS,t),this.emitServiceStatusEvent({context:"setConnectionStatus"}))}emitServiceStatusEvent(t={}){this.emit(e.EventType.SERVICE_STATUS,this.getServiceStatus())}getConnectionStatus(){return this.state._connectionStatus}getServiceStatus(){return{originatorInfo:this.state.originatorInfo,keyInfo:this.getKeyInfo(),connectionStatus:this.state._connectionStatus,channelConfig:this.state.channelConfig,channelId:this.state.channelId}}getKeyInfo(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.getKeyInfo()}resetKeys(){var e;null===(e=this.state.communicationLayer)||void 0===e||e.resetKeys()}setOtherPublicKey(e){var t;const n=null===(t=this.state.communicationLayer)||void 0===t?void 0:t.getKeyExchange();if(!n)throw new Error("KeyExchange is not initialized.");n.getOtherPublicKey()!==e&&n.setOtherPublicKey(e)}pause(){var t;return r(this,void 0,void 0,(function*(){F.RemoteCommunication(`[RemoteCommunication: pause()] channel=${this.state.channelId}`),yield null===(t=this.state.communicationLayer)||void 0===t?void 0:t.pause(),this.setConnectionStatus(e.ConnectionStatus.PAUSED)}))}getVersion(){return Ve.version}hasRelayPersistence(){var e;return null!==(e=this.state.relayPersistence)&&void 0!==e&&e}resume(){return r(this,void 0,void 0,(function*(){return function(t){var n;return r(this,void 0,void 0,(function*(){const{state:o}=t;F.RemoteCommunication(`[RemoteCommunication: resume()] channel=${o.channelId}`),yield null===(n=o.communicationLayer)||void 0===n?void 0:n.resume(),t.setConnectionStatus(e.ConnectionStatus.LINKED)}))}(this)}))}encrypt(e){var t,n,o;const i=null===(t=this.state.communicationLayer)||void 0===t?void 0:t.getKeyExchange(),r=null==i?void 0:i.getOtherPublicKey();if(!r)throw new Error("KeyExchange not completed");return null===(o=null===(n=this.state.communicationLayer)||void 0===n?void 0:n.state.eciesInstance)||void 0===o?void 0:o.encrypt(e,r)}decrypt(e){var t,n,o;if(!(null===(t=this.state.communicationLayer)||void 0===t?void 0:t.state.eciesInstance))throw new Error("ECIES instance is not initialized");return null===(o=null===(n=this.state.communicationLayer)||void 0===n?void 0:n.state.eciesInstance)||void 0===o?void 0:o.decrypt(e)}getChannelId(){return this.state.channelId}getRPCMethodTracker(){var e;return null===(e=this.state.communicationLayer)||void 0===e?void 0:e.getRPCMethodTracker()}reject({channelId:t}){return function({channelId:t,state:n}){var o,i,s;return r(this,void 0,void 0,(function*(){if(!ot(t))throw F.RemoteCommunication(`[RemoteCommunication: connectToChannel()] context=${n.context} invalid channel channelId=${t}`),new Error(`Invalid channel ${t}`);if(n.isOriginator)return void F.RemoteCommunication(`[RemoteCommunication: reject()] context=${n.context} isOriginator=${n.isOriginator} channelId=${t}`);const{socket:r}=null!==(i=null===(o=n.communicationLayer)||void 0===o?void 0:o.state)&&void 0!==i?i:{};(null==r?void 0:r.connected)||(F.RemoteCommunication(`[RemoteCommunication: reject()] context=${n.context} socket already connected`),null==r||r.connect()),G(Object.assign(Object.assign({id:t,event:e.TrackingEvents.REJECTED},n.originatorInfo),{sdkVersion:n.sdkVersion,commLayerVersion:Ve.version,walletVersion:null===(s=n.walletInfo)||void 0===s?void 0:s.version}),n.communicationServerUrl).catch((e=>{console.error("rejectChannel:: Error emitting analytics event",e)})),yield new Promise(((o,i)=>{null==r||r.emit(e.EventType.REJECTED,{channelId:t},((e,t)=>{F.RemoteCommunication(`[RemoteCommunication: reject()] context=${n.context} socket=${null==r?void 0:r.id}`,{error:e,response:t}),e?i(e):o(t)}))}))}))}({channelId:t,state:this.state})}disconnect(e){return r(this,void 0,void 0,(function*(){return jt({options:e,instance:this})}))}}e.AutoConnectType=void 0,(At=e.AutoConnectType||(e.AutoConnectType={})).RENEW="renew",At.LINK="link",e.DEFAULT_SERVER_URL=Ge,e.DEFAULT_SESSION_TIMEOUT_MS=Je,e.ECIES=Be,e.RemoteCommunication=zt,e.SendAnalytics=G,e.SocketService=_t}));
//# sourceMappingURL=metamask-sdk-communication-layer.js.map
