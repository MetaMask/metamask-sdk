name: Run E2E Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: Install dependencies
        run: yarn install
        run: cd e2e && yarn install && cd ..

      # Create .ios.env and .android.env with inputs in the /e2e directory
      - name: Create .ios.env and .android.env
        run: |
          echo "bs://b89256cdb82d39ad2b6868f743d1f48b63b744a1" > e2e/.ios.env
          echo "io.metamask.MetaMask-QA" >> e2e/.ios.env
          echo "bs://0a8158e21e87e7bda6036e0fd69e917e659d5058" > e2e/.android.env
          echo "io.metamask.qa" >> e2e/.android.env

      # Hard code .dapps.env values in the /e2e directory
      - name: Set Dapps Environment Variables
        run: |
          {
            echo "TEST_DAPP_URL=https://c0f4f41c-2f55-4863-921b-sdk-docs.github.io/test-dapp/";
            echo "SDK_PLAYGROUND_DAPP_URL=https://mmsdk-playground-test.vercel.app/demo";
            echo "CREATE_REACT_APP_DAPP_URL=https://metamask.github.io/metamask-sdk/deployments/45.0.0/packages/examples/create-react-app/build/";
            echo "VUE_JS_DAPP_URL=https://metamask.github.io/metamask-sdk/deployments/45.0.0/packages/examples/vuejs/dist/";
            echo "WEB3_ON_BOARD_DAPP_URL=https://mmsdk-playground-test.vercel.app/onboard";
          } > e2e/.dapps.env

      - name: Run Android E2E tests
        env:
          SRP: ${{ secrets.SRP }}
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BROWSERSTACK_API_USERNAME: ${{ secrets.BROWSERSTACK_API_USERNAME }}
          BROWSERSTACK_API_PASSWORD: ${{ secrets.BROWSERSTACK_API_PASSWORD }}
        run: yarn test:e2e:android:ci

      - name: Run IOS E2E tests
        env:
          SRP: ${{ secrets.SRP }}
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BROWSERSTACK_API_USERNAME: ${{ secrets.BROWSERSTACK_API_USERNAME }}
          BROWSERSTACK_API_PASSWORD: ${{ secrets.BROWSERSTACK_API_PASSWORD }}
        run: yarn test:e2e:ios:ci
